import{n as e,a3 as a,d0 as s,av as t,cc as l,bx as i,at as o,au as n,by as r,a2 as u,D as d,ay as c,bC as p,bN as m,cd as v,bJ as f,dL as b,bG as h,dw as _,E as g,F as x,bF as w,aW as y,nB as k,ac as N,M as j,bS as S,J as T,c as $,o as F,a as A,b as C,H as E,S as I,w as W,d as R,t as L,aY as z,aP as M,a5 as P,a6 as U,e as V,W as B,cN as H,aa as O,a8 as D,K as J,cQ as q,T as G,al as K,ax as Y,fm as Q,cO as Z,dq as X,bB as ee,bw as ae,ds as se,dt as te,du as le,dv as ie,dx as oe,dy as ne}from"./pxHhHUe5.js";import{_ as re}from"./mY5Y9jID.js";import{E as ue}from"./uG3PizZo.js";import{_ as de}from"./Bd4n395U.js";import{r as ce,u as pe}from"./Brqh9oRf.js";import{a as me}from"./D6xloY0K.js";import{u as ve}from"./DaNJHyoY.js";import"./-qzEQscJ.js";import"./Dcx-nvpN.js";import"./BC28JpVo.js";import"./xG3n2otq.js";import"./Ss6PgMLe.js";import"./DGdCcJ75.js";import"./CAY6cvuw.js";import"./3zf6s2PU.js";import"./DU6RBO19.js";import"./DAl9lCvA.js";import"./CJr2h2LL.js";import"./BwPtREp8.js";import"./D5SrGyNL.js";import"./coL0Kds6.js";import"./BRadLzUn.js";import"./Bd5vYUcI.js";import"./DQmdIPac.js";import"./C4ZtUdxm.js";import"./liJ_O3Tw.js";import"./CQ3Cm5RL.js";import"./B3CwgMQF.js";import"./B-rSTJlV.js";import"./8RBFgnO2.js";import"./b94L9vb_.js";import"./DlhmlHT6.js";import"./B-cUoYio.js";import"./pRNFjbOD.js";import"./BgFcDzLH.js";import"./CthYtH4c.js";import"./akGpTOBp.js";const fe={class:"flex justify-between items-center mt-10px pr-15px"},be=["infinite-scroll-disabled"],he={class:"pr-10px pb-20px"},_e={class:"flex-[1.5] flex items-center"},ge={class:"ml-6px"},xe={class:"flex"},we={class:"color-[var(--main-text)]"},ye={class:"mt-2px color-[--third-text]"},ke={class:"flex-1 flex flex-col items-end"},Ne={class:"flex-1 flex justify-end"},je={key:1,class:"color-[var(--d-EAECEF-l-333)]"},Se={key:0,class:"color-#959a9f text-12px text-center"},Te=e({__name:"positionsTable",props:{height:{type:[Number,String],default:370}},setup(e){const{updateHolderNum:Te}=a(s()),{t:$e}=t(),Fe=l(),Ae=i(),Ce=o();me();const Ee=ve(),Ie=n(),We=r(),{hide_risk:Re,hide_small:Le}=a(u());function ze(){Ye.value.pageNo=1,Ye.value.finished=!1}d(()=>Fe.wsResult[v.PRICEV2],e=>{const a={};e.prices.forEach(e=>{a[e.token+"-"+e.chain]=e}),Qe.value=Qe.value.map(e=>{const s=a[e.index];if(s&&s.uprice>0){const a="--"===e.total_profit||0===Number(e.total_profit),t=new p(e.balance||0).times(s.uprice||0);if(a)return{...e,current_price_usd:s.uprice,balance_usd:t.toNumber()};{const a=new p(e.balance_usd||0).minus(e.total_profit||0),l=t.minus(a),i=new p(s.uprice||0).minus(e.average_purchase_price_usd||0).div(e.average_purchase_price_usd);return i.toNumber()<-1||Number(e.average_purchase_price_usd)<0?e:{...e,current_price_usd:s.uprice,balance_usd:t.toNumber(),total_profit:l.toFixed(),total_profit_ratio:i.toFixed()}}}return e}),m(Qe)}),d(()=>Te.value,()=>{ze(),De()}),d(()=>Fe.wsResult[v.ASSET],e=>{var a;if(e.swap){const a="So11111111111111111111111111111111111111112"===e.swap.token||e.swap.token===b?b:e.swap.token,s=e.swap.chain;a&&s&&setTimeout(()=>{ze(),De()},5e3)}else if(e.transfer){const s=e.transfer.chain,t=e.transfer.token,l=e.transfer.type;if(t&&s){const i=Qe.value.findIndex(e=>e.token===t&&e.chain===s),o="0"===l;if(i>-1){const s=Qe.value[i],t=Number(s.balance),l=s.current_price_usd,n=new p(t).plus(o?e.transfer.amount:-(null==(a=e.transfer)?void 0:a.amount)),r=n.multipliedBy(l);s.balance=n.toString(),s.balance_usd=r.toNumber(),m(Qe)}else setTimeout(()=>{ze(),De()},5e3)}}}),h(function(e,a){const s=Ce.getWalletAddress(a);s&&_({chain:a,walletAddress:s,tokens:[e]}).then(s=>{Qe.value=Qe.value.map(t=>t.token===e&&t.chain===a?{...t,balance:s[0].balance,balance_usd:new p(s[0].balance||0).times(t.current_price_usd||0).toNumber()}:{...t})})},1e3,!1,!0);const Me=g(()=>{var e;return"evm"===(null==(e=N(Ie.chain))?void 0:e.vm_type)}),Pe=g(()=>Ce.userInfo?Ce.userInfo.addresses.map(({address:e,chain:a})=>e+"-"+a):Ie.address&&Me.value&&"WatchWallet"!==Ie.walletName?[Ie.address+"-bsc",Ie.address+"-base",Ie.address+"-eth"]:[Ie.address+"-"+Ie.chain]);d(()=>Pe.value,()=>{Ue.value.user_ids=Pe.value});const Ue=x({hide_risk:Re,hide_small:Le,user_ids:Pe.value}),Ve=x({}),Be=e,He=g(()=>Number(Be.height)-110),Oe=w("scrollContainerRef"),De=f(()=>{const{value:e}=Oe;e&&e.scrollHeight<=e.clientHeight&&!Ye.value.finished&&Ze()},200);d(He,De);const Je=c({sortBy:void 0,activeSort:0}),qe={"-1":"asc",1:"desc"},Ge=g(()=>({sort_dir:qe[Je.value.activeSort],sort:Je.value.sortBy})),Ke=g(()=>[{label:`${$e("token")}/${$e("balance1")}`,value:"balance_usd",flex:"flex-[1.5]",sort:!0},{label:$e("profit2"),value:"total_profit",flex:"flex-1 justify-end",sort:!0},{label:"",value:"",flex:"flex-1 justify-end",sort:!1}]),Ye=c({finished:!1,loading:!1,pageNo:1,pageSize:20}),Qe=c([]);async function Ze(){try{Ye.value.loading=!0;const e=Ye.value.pageNo,a=await k({pageNO:Ye.value.pageNo,pageSize:Ye.value.pageSize,...Ue.value,...Ge.value});if(Array.isArray(null==a?void 0:a.data)&&a.data.length>0){if(1===e)Qe.value=a.data.map(e=>{var a;return{...e,index:e.token===b?(null==(a=N(e.chain))?void 0:a.wmain_wrapper)+"-"+e.chain:`${e.token}-${e.chain}`}});else{const e=a.data.filter(e=>Qe.value.every(a=>a.index!==`${e.token}-${e.chain}`)).map(e=>{var a;return{...e,index:e.token===b?(null==(a=N(e.chain))?void 0:a.wmain_wrapper)+"-"+e.chain:`${e.token}-${e.chain}`}});Qe.value=Qe.value.concat(e)}Ye.value.finished=a.data.length<Ye.value.pageSize,Ye.value.finished||Ye.value.pageNo++}else 1===Ye.value.pageNo&&(Qe.value=[]);Ee.setMultiPriceParams("positions",Qe.value.map(e=>e.token+"-"+e.chain)),Ee.sendPriceWs()}catch(e){}finally{Ye.value.loading=!1,m(Ye)}}async function Xe(e){if(!Z())return;if(!e.token)return;const a=Ce.getWalletAddress(e.chain);if(a)try{Ve.value[e.index]=!0;const s=(await _({chain:e.chain,tokens:[e.token],walletAddress:a}))[0];s&&(e.balance=s.balance||0,e.balance_usd=new p(s.balance||0).times(e.current_price_usd||0).toNumber(),e.decimals=s.decimals||e.decimals);const t=s.balance||0;if(!t)return void X({title:"Error",type:"error",message:s("insufficientBalance")});!function(e,a){var s;if(!Z())return;if(new p(e||0).lte(0))return void X({title:"Error",type:"error",message:$e("amountMustG0")});const t=null==(s=new p(e||0).toFixed().match(new RegExp(`[0-9]*(\\.[0-9]{0,${a.decimals||18}})?`)))?void 0:s[0];if((Number(t)||0)<=0)return void X({title:"Error",type:"error",message:$e("amountTooSmall")});Ve.value[a.index]=!0,async function(e,a){var s,t,l,i,o;const n="solana"===a.chain,{botSettings:r}=Ae,u=null==(t=null==(s=null==r?void 0:r[a.chain])?void 0:s.sell)?void 0:t.selected,c=null==(i=null==(l=null==r?void 0:r[a.chain])?void 0:l.sell)?void 0:i[u],{gasTip1List:m,gasTip2List:v}=ee(ae().gasTip,"solana"),f=(null==c?void 0:c.mev)?m:v,h=(null==c?void 0:c.mev)?null==c?void 0:c.gas[0]:null==(o=null==c?void 0:c.gas)?void 0:o[1];let _={};if(n){let e=(null==h?void 0:h.customFee)||(null==f?void 0:f[null==h?void 0:h.level])||"0.002";(null==c?void 0:c.mev)&&new p(e).lt("0.002")&&(e="0.002"),_.priorityFee=new p(e).times(10**9).toFixed(0)}else{const e=0===Number(null==h?void 0:h.customFee)?"0":(null==h?void 0:h.customFee)||(null==f?void 0:f[null==h?void 0:h.level])||"3";_.gasTip=Number(new p(e).times(10**9).toFixed(0)),_.contractType=0,_.chain=a.chain}const g={solana:"sol",ton:"TON"}[a.chain]||b,x=(null==c?void 0:c.slippage)||"9",w=Ce.getWalletAddress(a.chain);if(!w)return;const y=Date.now().toString();_={..._,swapList:[{batchId:y,creatorAddress:w,inAmount:new p(e||0).times(10**a.decimals||0).toFixed(0)}],inTokenAddress:a.token,outTokenAddress:g,swapType:2,isPrivate:(null==c?void 0:c.mev)||!1,slippage:"auto"!==x?Number(new p(x).times(100).toFixed(0)):900};let k=se;n?k=oe:"ton"===a.chain&&(k=ne);k(_).then(e=>function(e,a,s,t){if(e){const l=(null==t?void 0:t.chain)||"",i=(null==e?void 0:e[0])||{};if(le(i))return te(ie(i)),void(Ve.value[s]=!1);let o=setTimeout(()=>{We.placeOrderUpdate++,Ve.value[s]=!1},500);const n={solana:"/botapi/swap/createSolTx",ton:"/botapi/swap/createSwapTonTx"};ce({txInfo:i,chain:l,destination:(null==n?void 0:n[l])||"/botapi/swap/createSwapEvmTx",type:10});const r={[null==i?void 0:i.batchId]:null==i?void 0:i.id},u=d(()=>Fe.wsResult.tgbot,e=>{var t,l,i,n,d;const c=e.batchId;if(c===a){if(o&&(clearTimeout(o),o=null),We.placeOrderSuccess++,null==(l=null==(t=null==e?void 0:e.txList)?void 0:t[0])?void 0:l.success){X({type:"success",message:$e("tradeSuccess")});const a=null==(i=null==e?void 0:e.txList)?void 0:i[0];pe({...a,chain:null==e?void 0:e.chain},(null==r?void 0:r[c])||"")}else te((null==(d=null==(n=null==e?void 0:e.txList)?void 0:n[0])?void 0:d.failMessage)||"swap error");u(),Ve.value[s]=!1}})}}(e,y,a.index,a)).catch(e=>{te(e||"swap error"),Ve.value[a.index]=!1})}(e,a)}(t,e)}finally{Ve.value[e.index]=!1}}return y(()=>{Ze()}),d(()=>[Ge.value,Ue.value.hide_risk,Ue.value.hide_small,Ce.evmAddress,()=>Ie.address,()=>Ie.walletSignature[Ie.address]],()=>{ze(),Ze()}),(e,a)=>{const s=z,t=re,l=H,i=B,o=O,n=G,r=V,u=Y,d=ue,c=Q,p=S;return j((F(),$("div",null,[A("div",fe,[C(s,{modelValue:T(Ue).hide_risk,"onUpdate:modelValue":a[0]||(a[0]=e=>T(Ue).hide_risk=e),class:"ml-12px",style:{marginRight:0},size:"small","true-value":1,"false-value":0},{default:W(()=>[R(L(e.$t("hideRiskTokenShort")),1)]),_:1},8,["modelValue"]),C(s,{modelValue:T(Ue).hide_small,"onUpdate:modelValue":a[1]||(a[1]=e=>T(Ue).hide_small=e),size:"small","true-value":1,"false-value":0},{default:W(()=>[R(L(e.$t("hideSmallAssets1")+"<1USD"),1)]),_:1},8,["modelValue"]),T(Ce).evmAddress||T(Ie).address&&T(Me)&&"WatchWallet"!==T(Ie).walletName?(F(),E(t,{key:0,userIds:T(Ue).user_ids,"onUpdate:userIds":[a[2]||(a[2]=e=>T(Ue).user_ids=e),a[3]||(a[3]=e=>{ze(),Ze()})]},null,8,["userIds"])):I("",!0)]),C(de,{sort:T(Je),"onUpdate:sort":a[4]||(a[4]=e=>M(Je)?Je.value=e:null),columns:T(Ke)},null,8,["sort","columns"]),C(d,{height:T(He)},{default:W(()=>[j((F(),$("div",{ref_key:"scrollContainerRef",ref:Oe,"infinite-scroll-disabled":T(Ye).finished||T(Ye).loading,"infinite-scroll-distance":"200","infinite-scroll-delay":10,"infinite-scroll-immediate":!1},[A("div",he,[(F(!0),$(P,null,U(T(Qe),(a,s)=>(F(),E(r,{key:s,class:"text-12px flex justify-between pl-10px py-10px cursor-pointer hover:bg-[--dialog-bg]",to:`/token/${a.index}`},{default:W(()=>[A("div",_e,[C(i,{"popper-class":"tooltip-pd-0",placement:"bottom-start","show-arrow":!1,persistent:!1},{default:W(()=>[C(l,{row:a},null,8,["row"])]),content:W(()=>[C(l,{row:a,"chain-class":"hidden","token-class":"w-240px h-240px [&&]:mr-0 rounded-16px"},null,8,["row"])]),_:2},1024),A("div",ge,[A("div",xe,[A("span",we,L(a.symbol),1),a.risk_score>55||a.risk_level<0?(F(),E(o,{key:0,name:"custom:danger",class:"font-14 ml-2px color-#F72121"})):I("",!0)]),A("div",ye,[0===a.balance?(F(),$(P,{key:0},[R("$0")],64)):"--"===a.balance?(F(),$(P,{key:1},[R("--")],64)):(F(),$(P,{key:2},[R(L(("formatNumber"in e?e.formatNumber:T(D))(a.balance,2))+"("+L("$"+("formatNumber"in e?e.formatNumber:T(D))(a.balance_usd||0,2))+") ",1)],64))])])]),A("div",ke,[A("div",{class:J(("getColorClass"in e?e.getColorClass:T(q))(a.total_profit))},[0===Number(a.total_profit)?(F(),$(P,{key:0},[R("0")],64)):"--"===a.total_profit?(F(),$(P,{key:1},[R("--")],64)):(F(),$(P,{key:2},[R(L(Number(a.total_profit)>0?"$":"-$")+L(("formatNumber"in e?e.formatNumber:T(D))(Math.abs(Number(a.total_profit)),2)),1)],64))],2),A("div",{class:J(("getColorClass"in e?e.getColorClass:T(q))(a.total_profit_ratio))},[0===Number(a.total_profit_ratio)?(F(),$(P,{key:0},[R("0")],64)):"--"===a.total_profit_ratio?(F(),$(P,{key:1},[R("--")],64)):(F(),$(P,{key:2},[R(L(Number(a.total_profit_ratio)>0?"+":"-")+L(("formatNumber"in e?e.formatNumber:T(D))(Math.abs(100*Number(a.total_profit_ratio)),2))+"% ",1)],64))],2)]),A("div",Ne,[T(Ce).evmAddress&&"0xeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee"!==a.token?(F(),E(n,{key:0,size:"small",loading:T(Ve)[a.index],class:"[--el-border:0] [&&]:[--el-button-bg-color:--d-222-l-F2F2F2] [&&]:font-normal",style:{padding:"4px"},onClick:K(e=>Xe(a),["stop","prevent"])},{default:W(()=>[R(L(e.$t("closePosition")),1)]),_:1},8,["loading","onClick"])):(F(),$("span",je,"--"))])]),_:2},1032,["to"]))),128)),0!==T(Qe).length||T(Ye).loading?I("",!0):(F(),E(u,{key:0}))]),T(Ye).loading&&1!==T(Ye).pageNo?(F(),$("div",Se,L(e.$t("loading")),1)):I("",!0)],8,be)),[[c,Ze]])]),_:1},8,["height"])])),[[p,T(Ye).loading&&1===T(Ye).pageNo]])}}});export{Te as default};
