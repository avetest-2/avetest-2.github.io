var e=Object.defineProperty,t=(t,i,r)=>((t,i,r)=>i in t?e(t,i,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[i]=r)(t,"symbol"!=typeof i?i+"":i,r);import{bC as i,go as r,n,D as a,F as o,aW as l,c as s,o as c,M as u,P as d,J as m,a as p,b as g,aa as h,t as v,w as f,d as w,al as x,T as I,H as R,S,a5 as P,au as F,ac as k,eP as y,eS as b,o1 as T,eO as L,dM as O,o2 as E,av as N,ak as z,E as M,o3 as C,a6 as A,aT as _,a8 as B,o4 as D,dX as U,dq as V,cB as q,ek as K,aR as G,eg as W,_ as $,o5 as Y,o6 as j,K as Z,at as H,a3 as X,a2 as J,ah as Q,o7 as ee,b$ as te,fR as ie,fS as re,bA as ne}from"./pxHhHUe5.js";import{a as ae,E as oe}from"./BC28JpVo.js";import"./xG3n2otq.js";import"./uG3PizZo.js";i.set({DECIMAL_PLACES:34,ROUNDING_MODE:i.ROUND_HALF_UP});class le{static toDecimal(e){if(null==e||""===e)return new i(0);try{return new i(e)}catch(t){return new i(0)}}static isEqualZero(e){return e.isZero()}static isMoreZero(e){return e.gt(0)}static isMoreOrEqualZero(e){return e.gte(0)}static isLessZero(e){return e.lt(0)}static isLessOrEqualZero(e){return e.lte(0)}static isEqualNum(e,t){return e.eq(t)}static isMoreNum(e,t){return e.gt(t)}static isMoreOrEqualNum(e,t){return e.gte(t)}static isLessNum(e,t){return e.lt(t)}static isLessOrEqualNum(e,t){return e.lte(t)}static add(e,t){return new i(e).plus(t).toString()}static subtract(e,t){return new i(e).minus(t).toString()}static multiply(e,t){return new i(e).multipliedBy(t).toString()}static divide(e,t){return new i(t).isZero()?"-":new i(e).dividedBy(t).toFixed(this.DEFAULT_SCALE)}static digitMergeNumber(e,t,r){const n=new i(e),a=new i(t);if(a.isZero())return n.toString();const o=n.div(a),l=o.mod(1);let s=new i(0);r?l.isZero()||(s=a):l.gte(.5)&&(s=a);return o.integerValue(i.ROUND_FLOOR).multipliedBy(a).plus(s).toString()}static max(e,t){return e.gt(t)?e:t}static min(e,t){return e.lt(t)?e:t}static ceil(e,t){return new i(e).decimalPlaces(t,i.ROUND_CEIL).toString()}static floor(e,t){return new i(e).decimalPlaces(t,i.ROUND_FLOOR).toString()}static round(e,t){return new i(e).decimalPlaces(t,i.ROUND_HALF_UP).toString()}static getPrecision(e){const t=e.abs().toNumber();if(t>=1e5)return 0;if(t>=1e4)return 1;if(t>=1e3||0===t)return 2;if(t>=100)return 3;if(t>=10)return 4;if(t>=1)return 5;const i=e.toString();if(i.includes(".")){const e=i.split(".")[1];for(let t=0;t<e.length;t++)if("0"!==e[t])return t+4}return 2}static handPrecision(e){const t=this.getPrecision(e);return this.round(e,t)}static handNumber(e,t=2,r=2){const n=e,a=n.abs(),o=new i(1e3),l=new i(1e6),s=new i(1e9);let c=n.toFixed(t),u="";return a.gte(s)?(c=n.div(s).toFixed(r),u="B"):a.gte(l)?(c=n.div(l).toFixed(r),u="M"):a.gte(o)&&(c=n.div(o).toFixed(r),u="K"),c+u}}function se(e){const t=String(e).split(".");return t.length<=2?t[1]?t[1].length:0:2}function ce(e,t,i){const r=Number(e);if(isNaN(r)||Number(t)<=0)return String(e);let n;const a=Number(t);if(a>=1)n=(Math[i?"floor":"round"](r/a)*a).toFixed(se(t));else{const e=String(t).length-2;n=me(Math[i?"floor":"round"](me(r,1/a)),a).toFixed(e)}return 0===Number(n)&&0!==r?String(t):n}function ue(e,t=2,r=!1){const n=Number(i(e).toNumber()),a=void 0===t?2:t;if(void 0===e)return(0).toFixed(a);const o=Math.pow(10,Math.ceil(a)),l=String(isNaN(n)?e:(Math.floor(me(n,o))/o).toFixed(a));return Boolean(r)&&0===Number(l)?String(Math.pow(10,-t)):l}function de(e,t,r){const n=Number(i(e).toNumber()),a=void 0===t?2:t;if(isNaN(n))return(0).toFixed(a);const o=Math.pow(10,a),l=(Math.floor(me(n,o))/o).toFixed(a).split("."),s=2===l.length?`${Number(l[0]).toLocaleString("en-US")}.${l[1]}`:Number(l[0]).toLocaleString("en-US");return Boolean(r)&&0===Number(s.replace(/\\,/g,""))?String(Math.pow(10,-a)):s}function me(...e){switch(!0){case!e.length:return 0;case 1===e.length:return new i(e[0]).toNumber();default:return e.slice(1).reduce((e,t)=>e.multipliedBy(isNaN(Number(t))?1:Number(t)),new i(e[0])).toNumber()}}t(le,"DEFAULT_SCALE",25);var pe=(e=>(e.BUY="BUY",e.SELL="SELL",e))(pe||{}),ge=(e=>(e.MARKET="MARKET",e.LIMIT="LIMIT",e.STOP_MARKET="STOP_MARKET",e.STOP_LIMIT="STOP_LIMIT",e.TAKE_PROFIT_MARKET="TAKE_PROFIT_MARKET",e.TAKE_PROFIT_LIMIT="TAKE_PROFIT_LIMIT",e.LADDER_ORDERS="LADDER_ORDERS",e))(ge||{}),he=(e=>(e.PENDING="PENDING",e.UNTRIGGERED="UNTRIGGERED",e.OPEN="OPEN",e.CANCELING="CANCELING",e.EXECUTING="EXECUTING",e.FILLED="FILLED",e.CANCELED="CANCELED",e.FAILED="FAILED",e.INTERNAL_FAILED="INTERNAL_FAILED",e))(he||{}),ve=(e=>(e.LAST_PRICE="LAST_PRICE",e.ORACLE_PRICE="ORACLE_PRICE",e.INDEX_PRICE="INDEX_PRICE",e))(ve||{}),fe=(e=>(e.GOOD_TIL_CANCEL="GOOD_TIL_CANCEL",e.IMMEDIATE_OR_CANCEL="IMMEDIATE_OR_CANCEL",e.FILL_OR_KILL="FILL_OR_KILL",e.POST_ONLY="POST_ONLY",e))(fe||{}),we=(e=>(e.LONG="LONG",e.SHORT="SHORT",e))(we||{});class xe{constructor(e){this.raw=e}static fromRaw(e){return new xe(e)}get id(){return this.raw.id}get userId(){return this.raw.userId}get ethAddress(){return this.raw.ethAddress}get accountName(){return this.raw.accountName}get user(){return this.raw.user}get l2Key(){return this.raw.l2Key}get l2KeyYCoordinate(){return this.raw.l2KeyYCoordinate}get clientAccountId(){return this.raw.clientAccountId}get wallet(){return this.raw.wallet}get walletIcon(){return this.raw.walletIcon}get smartWalletAddress(){return this.raw.smartWalletAddress}get extraType(){return this.raw.extraType}get extraDataJson(){return this.raw.extraDataJson}get status(){return this.raw.status}get createdTime(){return new Date(Number(this.raw.createdTime))}get updatedTime(){return new Date(Number(this.raw.updatedTime))}get isSystemAccount(){return this.raw.isSystemAccount}get isLiquidating(){return this.raw.isLiquidating}get maxLeverageLimit(){return this.raw.maxLeverageLimit}get createOrderPerMinuteLimit(){return this.raw.createOrderPerMinuteLimit}get createOrderDelayMillis(){return this.raw.createOrderDelayMillis}get defaultTradeSetting(){return this.raw.defaultTradeSetting}get contractIdToTradeSetting(){return this.raw.contractIdToTradeSetting}getTradeSetting(e){return this.raw.contractIdToTradeSetting&&this.raw.contractIdToTradeSetting[e]?this.raw.contractIdToTradeSetting[e]:this.raw.defaultTradeSetting}get userPreference(){return this.raw.userPreference}get keys(){return this.raw.keys}getEffectiveFeeRate(e,t){var r,n;const a=null==(r=this.raw.contractIdToTradeSetting)?void 0:r[e],o=null==(n=null==t?void 0:t.contractList)?void 0:n.find(t=>t.contractId===e),l=this.raw.defaultTradeSetting;return(null==a?void 0:a.isSetFeeRate)?{takerFeeRate:null==a?void 0:a.takerFeeRate,makerFeeRate:null==a?void 0:a.makerFeeRate}:(null==a?void 0:a.isSetFeeDiscount)?{takerFeeRate:i((null==o?void 0:o.defaultTakerFeeRate)||0).multipliedBy(null==a?void 0:a.takerFeeDiscount).toString(),makerFeeRate:i((null==o?void 0:o.defaultMakerFeeRate)||0).multipliedBy(null==a?void 0:a.makerFeeDiscount).toString()}:(null==l?void 0:l.isSetFeeRate)?{takerFeeRate:null==l?void 0:l.takerFeeRate,makerFeeRate:null==l?void 0:l.makerFeeRate}:(null==l?void 0:l.isSetFeeDiscount)?{takerFeeRate:i((null==o?void 0:o.defaultTakerFeeRate)||0).multipliedBy(null==l?void 0:l.takerFeeDiscount).toString(),makerFeeRate:i((null==o?void 0:o.defaultMakerFeeRate)||0).multipliedBy(null==l?void 0:l.makerFeeDiscount).toString()}:{takerFeeRate:null==o?void 0:o.defaultTakerFeeRate,makerFeeRate:null==o?void 0:o.defaultMakerFeeRate}}getEffectiveMaxLeverage(e,t){var i,r;const n=null==(i=this.raw.contractIdToTradeSetting)?void 0:i[e],a=null==(r=null==t?void 0:t.contractList)?void 0:r.find(t=>t.contractId===e),o=this.raw.defaultTradeSetting;return(null==n?void 0:n.isSetMaxLeverage)?Number(null==n?void 0:n.maxLeverage):(null==o?void 0:o.isSetMaxLeverage)?Number(null==o?void 0:o.maxLeverage):Number(null==a?void 0:a.defaultLeverage)}}class Ie{constructor(e,t,i){this.raw=e,this.index=t,this.risks=i}get tier(){return this.raw.tier}get positionValueUpperBound(){return this.raw.positionValueUpperBound}get maxLeverage(){return Number(this.raw.maxLeverage)}get maintenanceMarginRate(){return Number(this.raw.maintenanceMarginRate)}get starkExRisk(){return this.raw.starkExRisk}get starkExUpperBound(){return this.raw.starkExUpperBound}get initialMarginRate(){return 1/this.maxLeverage}get startValue(){var e;return de((null==(e=this.risks[this.index-1])?void 0:e.positionValueUpperBound)||"0",0)}get endValue(){return Number(this.positionValueUpperBound)>=Number.MAX_SAFE_INTEGER?"âˆž":de(this.positionValueUpperBound,0)}isInCurrentLevel(e,t){var i;const r=Math.abs(me(e||0,t||0));return r>0&&r<Number(this.positionValueUpperBound)&&r>=Number((null==(i=this.risks[this.index-1])?void 0:i.positionValueUpperBound)||0)}static findByValue(e,t){if(!t)return null;const r=i(e).abs();let n=i(0);for(const a of t){const e=i(a.positionValueUpperBound||0);if(n.lte(r)&&r.lt(e))return a;n=e}return null}}class Re{constructor(e){this.raw=e}static fromRaw(e){return new Re(e)}get contractId(){return this.raw.contractId}get contractName(){return this.raw.contractName}get baseCoinId(){return this.raw.baseCoinId}get quoteCoinId(){return this.raw.quoteCoinId}get tickSize(){return this.raw.tickSize}get stepSize(){return this.raw.stepSize}get minOrderSize(){return this.raw.minOrderSize}get maxOrderSize(){return this.raw.maxOrderSize}get maxOrderBuyPriceRatio(){return this.raw.maxOrderBuyPriceRatio}get minOrderSellPriceRatio(){return this.raw.minOrderSellPriceRatio}get maxPositionSize(){return this.raw.maxPositionSize}get maxMarketPositionSize(){return this.raw.maxMarketPositionSize}get riskTierList(){return this.raw.riskTierList.map((e,t)=>new Ie(e,t,this.raw.riskTierList))}get defaultTakerFeeRate(){return this.raw.defaultTakerFeeRate}get defaultMakerFeeRate(){return this.raw.defaultMakerFeeRate}get defaultLeverage(){return this.raw.defaultLeverage}get liquidateFeeRate(){return this.raw.liquidateFeeRate}get enableTrade(){return this.raw.enableTrade}get enableDisplay(){return this.raw.enableDisplay}get enableOpenPosition(){return this.raw.enableOpenPosition}get fundingInterestRate(){return this.raw.fundingInterestRate}get fundingImpactMarginNotional(){return this.raw.fundingImpactMarginNotional}get fundingMaxRate(){return this.raw.fundingMaxRate}get fundingMinRate(){return this.raw.fundingMinRate}get fundingRateIntervalMin(){return this.raw.fundingRateIntervalMin}get displayDigitMerge(){return this.raw.displayDigitMerge}get displayMaxLeverage(){return this.raw.displayMaxLeverage}get displayMinLeverage(){return this.raw.displayMinLeverage}get displayNewIcon(){return this.raw.displayNewIcon}get displayHotIcon(){return this.raw.displayHotIcon}get matchServerName(){return this.raw.matchServerName}get starkExSyntheticAssetId(){return this.raw.starkExSyntheticAssetId}get starkExResolution(){return this.raw.starkExResolution}get starkExOraclePriceQuorum(){return this.raw.starkExOraclePriceQuorum}get starkExOraclePriceSignedAssetId(){return this.raw.starkExOraclePriceSignedAssetId}get starkExOraclePriceSigner(){return this.raw.starkExOraclePriceSigner}get symbol(){return this.raw.symbol}get pricePrecision(){return this.raw.pricePrecision??2}get priceStep(){return this.raw.priceStep}get sizePrecision(){return this.raw.sizePrecision??2}get sizeStep(){return this.raw.sizeStep}get baseCoin(){return this.raw.baseCoin}get baseCoinPrecision(){return this.raw.baseCoinPrecision??2}get baseCoinRealPrecision(){return this.raw.baseCoinRealPrecision??2}get baseCoinIcon(){return this.raw.baseCoinIcon}get quoteCoinPrecision(){return this.raw.quoteCoinPrecision??2}get pnlPrecision(){return this.raw.pnlPrecision??2}get quoteCoinRealPrecision(){return this.raw.quoteCoinRealPrecision??2}get quoteCoin(){return this.raw.quoteCoin}get quoteCoinIcon(){return this.raw.quoteCoinIcon}get lastPrice(){return this.raw.lastPrice}getRiskTier(e){const t=this.riskTierList;if(!t||0===t.length)return;const r=new i(e).abs();let n=new i(0);for(const a of t){const e=new i(a.positionValueUpperBound||0);if(n.lte(r)&&r.lt(e))return a;n=e}}formatPrice(e,t="round"){if(""===e||null==e)return"0";if("number"==typeof e&&isNaN(e))return"0";if(i.isBigNumber(e)&&e.isNaN())return"0";const r=i.isBigNumber(e)?e.toFixed():String(e);if(this.raw.priceStep&&Number(this.raw.priceStep)>0){if("ceil"===t){const e=new i(this.raw.priceStep);return new i(r).div(e).integerValue(i.ROUND_CEIL).multipliedBy(e).toFixed(this.pricePrecision)}const e="floor"===t;return ce(r,this.raw.priceStep,e)}return ue(r,this.pricePrecision)}formatPriceFormatted(e,t="round"){const i=this.formatPrice(e,t).split(".");return i[0]=i[0].replace(/\B(?=(\d{3})+(?!\d))/g,","),i.join(".")}formatSize(e){if(""===e||null==e)return"0";return ce(i.isBigNumber(e)?e.toFixed():String(e),this.raw.sizeStep,!0)}formatSizeFormatted(e){const t=this.formatSize(e).split(".");return t[0]=t[0].replace(/\B(?=(\d{3})+(?!\d))/g,","),t.join(".")}formatQuoteValue(e){return de(e,this.quoteCoinPrecision)}formatPnL(e){return de(e,this.pnlPrecision)}formatNotionalValue(e){return ue(e,this.quoteCoinPrecision)}calculateNotionalValue(e,t){return new i(e).multipliedBy(t)}getMaxLeverage(e=0){const t=this.raw.riskTierList;if(!t||0===t.length)return this.raw.displayMaxLeverage;const r=new i(e).abs();for(const i of t)if(r.lte(i.positionValueUpperBound))return i.maxLeverage;return t[t.length-1].maxLeverage}isSizeValid(e){return new i(e).gte(this.minOrderSize)}isZeroFee(e,t){var i;if(!e)return!1;try{let r,n;if(t)({takerFeeRate:r,makerFeeRate:n}=xe.fromRaw(t).getEffectiveFeeRate(this.contractId,e));else{const t=null==(i=e.contractList)?void 0:i.find(e=>e.contractId===this.contractId);r=null==t?void 0:t.defaultTakerFeeRate,n=null==t?void 0:t.defaultMakerFeeRate}return 0===parseFloat(String(r||0))&&0===parseFloat(String(n||0))}catch(r){return!1}}}function Se(e){const{oraclePrice:t,initialMarginRate:r,size:n,value:a,feeRate:o}=e,l=i.max(i(a).minus(i(n).multipliedBy(t)),0),s=i(n).abs().multipliedBy(t).multipliedBy(r),c=i(a).abs().multipliedBy(o);return l.plus(s).plus(c)}function Pe(e){const{oraclePrice:t,initialMarginRate:r,size:n,value:a,feeRate:o}=e,l=i(a).minus(i(n).multipliedBy(t)),s=i(n).abs().multipliedBy(t).multipliedBy(r),c=i(a).abs().multipliedBy(o);return l.minus(s).plus(c)}function Fe(e){const{side:t,entryPrice:r,markPrice:n,size:a}=e,o=i(r),l=i(n),s=i(a);return"LONG"===t?l.minus(o).multipliedBy(s):o.minus(l).multipliedBy(s)}const ke=i(2).pow(32);function ye(e,t){if(!t||0===t.length)return i(0);const r=i(e).abs();let n=i(0);for(const a of t){const e=i(a.positionValueUpperBound||0);if(n.lte(r)&&r.lt(e))return i(a.starkExRisk||0).dividedBy(ke);n=e}return i(0)}function be(e){const{openSize:t,fixStarkExRiskRate:r,oraclePrice:n,totalEquity:a,starkExRiskValue:o,pricePrecision:l}=e,s=i(t),c=i(r),u=i(n),d=i(a),m=i(o);return s.gt(0)&&c.lt(1)?u.minus(d.minus(m).dividedBy(s.multipliedBy(i(1).minus(c)))).toFixed(l,i.ROUND_CEIL):s.lt(0)?u.minus(d.minus(m).dividedBy(s.multipliedBy(i(1).plus(c)))).toFixed(l,i.ROUND_FLOOR):"0"}class Te{constructor(e,i){t(this,"symbol"),this.raw=i,this.symbol=e instanceof Re?e:Re.fromRaw(e)}get userId(){return this.raw.userId}get accountId(){return this.raw.accountId}get coinId(){return this.raw.coinId}get contractId(){return this.raw.contractId}get openSize(){return this.raw.openSize}get size(){return Math.abs(Number(this.raw.openSize))}get sizeFormatted(){return this.symbol.formatSizeFormatted(this.size)}get openValue(){return this.raw.openValue}get openFee(){return this.raw.openFee}get fundingFee(){return this.raw.fundingFee}get longTermCount(){return this.raw.longTermCount}get longTermStat(){return this.raw.longTermStat}get longTermCreatedTime(){return this.raw.longTermCreatedTime}get longTermUpdatedTime(){return this.raw.longTermUpdatedTime}get shortTermCount(){return this.raw.shortTermCount}get shortTermStat(){return this.raw.shortTermStat}get shortTermCreatedTime(){return this.raw.shortTermCreatedTime}get shortTermUpdatedTime(){return this.raw.shortTermUpdatedTime}get longTotalStat(){return this.raw.longTotalStat}get shortTotalStat(){return this.raw.shortTotalStat}get createdTime(){return this.raw.createdTime}get updatedTime(){return this.raw.updatedTime}get id(){return this.raw.id}get from(){return this.raw.from}get isLong(){return Number(this.raw.openSize)>0}get side(){return this.isLong?"LONG":"SHORT"}get isVisible(){return this.symbol.enableDisplay}get entryPrice(){return i(this.openValue).div(this.openSize).toFixed(this.symbol.pricePrecision,this.isLong?i.ROUND_CEIL:i.ROUND_DOWN)}get entryPriceFormatted(){return this.symbol.formatPriceFormatted(this.entryPrice,"round")}get closedPositionTermPnl(){const e=Number(this.openValue)>0,t=this.openValue;let r=0,n=0;return e?r=i(0).plus(this.longTotalStat.cumOpenValue).minus(t).plus(this.longTotalStat.cumCloseValue).negated().toNumber():n=i(0).plus(this.shortTotalStat.cumOpenValue).minus(t).plus(this.shortTotalStat.cumCloseValue).negated().toNumber(),i(0).plus(r).plus(n).toNumber()}get realizedPnl(){return i(this.fundingFee||0).plus(this.openFee||0).plus(this.closedPositionTermPnl||0).toNumber()}get realizedPnlFormatted(){const e=this.realizedPnl;return(i(e).gte(0)?"+":"")+this.symbol.formatPnL(e)}get realizedPnlFormattedLong(){const e=this.realizedPnl;return(i(e).gte(0)?"+":"")+this.symbol.formatQuoteValue(e)}get breakEvenPrice(){const e=i(this.symbol.defaultTakerFeeRate),t=i(this.entryPrice),r=this.size,n=i(this.closedPositionTermPnl);let a;return a=this.isLong?t.minus(n.div(r)).div(i(1).plus(e)):t.plus(n.div(r)).div(i(1).minus(e)),a.toFixed(this.symbol.pricePrecision,i.ROUND_DOWN)}get breakEvenPriceFormatted(){return this.symbol.formatPriceFormatted(this.breakEvenPrice,"floor")}getUnrealizedPnl(e){return Fe({side:this.side,entryPrice:this.entryPrice,markPrice:String(e),size:String(this.size)})}getUnrealizedPnlRoe(e,t){return function(e){const{side:t,entryPrice:r,markPrice:n,size:a,leverage:o}=e,l=Fe({side:t,entryPrice:r,markPrice:n,size:a}),s=i(r),c=i(a),u=i(o),d=s.multipliedBy(c).dividedBy(u);return d.isZero()?i(0):l.dividedBy(d).multipliedBy(100)}({side:this.side,entryPrice:this.entryPrice,markPrice:String(e),size:String(this.size),leverage:String(t)})}getUnrealizedPnlRoeFormatted(e,t){return`${de(this.getUnrealizedPnlRoe(e,t).toNumber(),2,!1)}%`}getWorstClosePrice(e,t,r){const n=this.getRiskTiersForCalculator(),a=this.getPricePrecision();return function(e){const{oraclePrice:t,openSize:r,riskTiers:n,pricePrecision:a,collateralInfo:o,feeRate:l}=e,{totalEquity:s,starkExRiskValue:c,pendingWithdrawAmount:u,pendingTransferOutAmount:d}=o,m=i(s).minus(u).minus(d),p=i(r),g=i(l),h=ye(p.multipliedBy(t).abs(),n),v=p.comparedTo(0);if(null===v||0===v)return i(0);if(v<0){const e=m.multipliedBy(h).plus(c).multipliedBy(t).dividedBy(i(c).multipliedBy(i(1).plus(g))).toFixed(a,i.ROUND_FLOOR),r=m.minus(c).plus(p.negated().multipliedBy(t).multipliedBy(i(1).plus(h))).dividedBy(p.negated().multipliedBy(i(1).plus(g))).toFixed(a,i.ROUND_FLOOR);return i.max(e,r)}{const e=i(c).minus(m.multipliedBy(h)).multipliedBy(t).dividedBy(i(c).multipliedBy(i(1).minus(g))).toFixed(a,i.ROUND_CEIL),r=m.minus(c).plus(p.negated().multipliedBy(t).multipliedBy(i(1).minus(h))).dividedBy(p.negated().multipliedBy(i(1).minus(g))).toFixed(a,i.ROUND_CEIL);return i.min(e,r)}}({oraclePrice:e,openSize:this.openSize,riskTiers:n,pricePrecision:a,collateralInfo:t,feeRate:r})}getTpslInfo(e){const t=this.isLong?pe.SELL:pe.BUY,r=e.filter(e=>e.contractId===this.contractId&&e.side===t&&e.isTpslOrder()),n=r.filter(e=>e.type===ge.TAKE_PROFIT_MARKET).reduce((e,t)=>e.plus(t.size),new i(0)),a=r.filter(e=>e.type===ge.STOP_MARKET).reduce((e,t)=>e.plus(t.size),new i(0));return{tpslOrders:r,tpVolume:n.toNumber(),slVolume:a.toNumber()}}getInitialMarginRequirement(e,t){const r=new i(this.size).multipliedBy(e).abs(),n=new i(t),a=n.isZero()?new i(1):n,o=this.symbol.quoteCoinRealPrecision??this.symbol.quoteCoinPrecision??2;return r.div(a).decimalPlaces(o,i.ROUND_CEIL)}getActualLeverage(e,t){const r=new i(this.size).multipliedBy(e).abs(),n=this.symbol.getRiskTier(r.toString()),a=(null==n?void 0:n.maxLeverage)||t;return i.min(t,a)}getCurrentValue(e){return new i(this.openSize).multipliedBy(e)}getStarkExRiskValue(e){const t=new i(this.size).multipliedBy(e).abs(),r=this.symbol.getRiskTier(t.toString()),n=i((null==r?void 0:r.starkExRisk)||0).div(i(2).pow(32));return t.multipliedBy(n)}getLiquidationPrice(e,t){const r=this.getRiskTiersForCalculator();return function(e){const{oraclePrice:t,openSize:r,riskTiers:n,tickSize:a,collateralInfo:o}=e,{totalEquity:l,starkExRiskValue:s,pendingWithdrawAmount:c,pendingTransferOutAmount:u}=o,d=i(r),m=se(String(a)),p=i(l).minus(c).minus(u),g=d.multipliedBy(t),h=ye(g.abs(),n),v=g.abs().multipliedBy(h);if(d.gt(0)){if(!n||0===n.length)return"0";for(let e=n.length-1;e>=0;e--){const r=n[e],a=n[e-1],o=i(a?a.positionValueUpperBound:0),l=i(r.positionValueUpperBound),c=i(r.starkExRisk||0).dividedBy(ke),u=be({openSize:d,fixStarkExRiskRate:c,oraclePrice:t,totalEquity:p,starkExRiskValue:i(s).minus(v).plus(g.abs().multipliedBy(c)),pricePrecision:m}),h=i(u).multipliedBy(d).abs();if(!h.lte(o))return h.lte(l)?u:l.dividedBy(d).toFixed(m,i.ROUND_FLOOR)}return"0"}if(d.lt(0)){if(!n||0===n.length)return be({openSize:d,fixStarkExRiskRate:"1",oraclePrice:t,totalEquity:p,starkExRiskValue:s,pricePrecision:m});for(let e=0;e<n.length;e++){const r=n[e],o=n[e-1],l=i(o?o.positionValueUpperBound:0),c=i(r.positionValueUpperBound),u=i(r.starkExRisk||0).dividedBy(ke),h=be({openSize:d,fixStarkExRiskRate:u,oraclePrice:t,totalEquity:p,starkExRiskValue:i(s).minus(v).plus(g.abs().multipliedBy(u)),pricePrecision:m}),f=i(h).multipliedBy(d).abs();if(f.lte(l)){let e=l.dividedBy(d).toFixed(m,i.ROUND_CEIL);return i(e).multipliedBy(d).abs().eq(f)&&(e=i(e).plus(a).toString()),e}if(f.lte(c))return h}return be({openSize:d,fixStarkExRiskRate:"1",oraclePrice:t,totalEquity:p,starkExRiskValue:s,pricePrecision:m})}return"0"}({oraclePrice:e,openSize:this.openSize,riskTiers:r,tickSize:this.symbol.tickSize,collateralInfo:t})}getRiskTiersForCalculator(){return this.symbol.riskTierList&&0!==this.symbol.riskTierList.length?this.symbol.riskTierList.map(e=>({positionValueUpperBound:e.positionValueUpperBound,maintenanceMarginRate:e.maintenanceMarginRate,starkExRisk:e.starkExRisk})):[]}getPricePrecision(){return se(this.symbol.tickSize)}}class Le extends Error{constructor(e){super(e),this.name=this.constructor.name,Object.setPrototypeOf(this,new.target.prototype)}}class Oe extends Le{constructor(e,t="Cannot calculate value for market order without current price"){super(t),this.orderType=e,this.reason=t}}ge.MARKET,ge.STOP_MARKET,ge.TAKE_PROFIT_MARKET,ge.LIMIT,ge.STOP_LIMIT,ge.TAKE_PROFIT_LIMIT,ge.STOP_MARKET,ge.STOP_LIMIT,ge.TAKE_PROFIT_MARKET,ge.TAKE_PROFIT_LIMIT;const Ee="BUY",Ne="SELL",ze="PENDING_CHECKING",Me="PENDING_CENSORING",Ce="SUCCESS_L2_APPROVED",Ae="FAILED_CHECK_INVALID",_e="FAILED_CENSOR_FAILURE",Be="FAILED_L2_REJECT",De="FAILED_L2_REJECT_APPROVED",Ue="PENDING_CENSORING",Ve="SUCCESS_L2_APPROVED",qe="FAILED_CENSOR_FAILURE",Ke="FAILED_L2_REJECT",Ge="FAILED_L2_REJECT_APPROVED",We=["STOP_MARKET","TAKE_PROFIT_MARKET","STOP_LIMIT","TAKE_PROFIT_LIMIT"];class $e{constructor(e,i){t(this,"symbol"),this.raw=i,this.symbol=e instanceof Re?e:Re.fromRaw(e)}static fromRaw(e,t){return new $e(e,t)}static comparator(e,t){const i=e instanceof $e?e.raw:e,r=t instanceof $e?t.raw:t,n=Number(i.contractId)-Number(r.contractId);if(0!==n)return n;const a=e=>"BUY"===e?0:1,o=a(i.side)-a(r.side);if(0!==o)return o;const l=Number(i.price),s=Number(r.price),c=0===l,u=0===s;if(c&&!u)return-1;if(!c&&u)return 1;if("BUY"===i.side){if(s!==l)return s-l}else if(l!==s)return l-s;const d=e=>{const t=We.includes(e.type);return Number(t?e.triggerTime:e.createdTime)},m=d(r)-d(i);return 0!==m?m:i.id.localeCompare(r.id)}static sort(e){return e.sort($e.comparator)}getFillData(e){let t=i(0);if(t=["PENDING","OPEN","CANCELING"].includes(this.status)?i(this.size).minus(this.raw.cumFailSize||0).minus(this.raw.cumFillSize||0):i(this.raw.cumMatchSize||0).minus(this.raw.cumFailSize||0).minus(this.raw.cumFillSize||0),t.lte(0))return{closeSize:i(0),closeValue:i(0),openSize:i(0),openValue:i(0)};let r=i(0);r=this.price&&"0"!=this.price?t.multipliedBy(i(this.price)):i(t.multipliedBy(i(this.raw.marketLimitValue||0)).dividedBy(i(this.size).toFixed(se(this.symbol.stepSize),"BUY"==this.side?i.ROUND_CEIL:i.ROUND_FLOOR)));let n=i(0);"BUY"==this.side&&e.lt(0)?n=i.min(e.abs(),t):"SELL"==this.side&&e.gt(0)&&(n=i(0).minus(i.min(e,t)));let a=i(0);a="BUY"==this.side?i(t).minus(i(n)):i(t).negated().minus(i(n));const o=i(n.multipliedBy(r).dividedBy(t.toFixed(se(this.symbol.stepSize),"BUY"==this.side?i.ROUND_CEIL:i.ROUND_FLOOR)));return{closeSize:n,closeValue:o,openSize:a,openValue:"BUY"==this.side?r.minus(o):r.negated().minus(o)}}canCancel(){return e=this.status,["OPEN","UNTRIGGERED"].includes(e);var e}isActive(){return[he.PENDING,he.OPEN,he.CANCELING].includes(this.status)}isConditional(){return this.status===he.UNTRIGGERED}isCompleted(){return e=this.status,["FILLED","CANCELED","FAILED"].includes(e);var e}isFilled(){return this.status===he.FILLED}isCanceled(){return this.status===he.CANCELED}isFailed(){return this.status===he.FAILED||this.status===he.INTERNAL_FAILED}isMarketOrder(){return e=this.type,["MARKET","STOP_MARKET","TAKE_PROFIT_MARKET"].includes(e);var e}isLimitOrder(){return e=this.type,["LIMIT","STOP_LIMIT","TAKE_PROFIT_LIMIT"].includes(e);var e}isConditionalOrder(){return e=this.type,["STOP_MARKET","STOP_LIMIT","TAKE_PROFIT_MARKET","TAKE_PROFIT_LIMIT"].includes(e);var e}isStopOrder(){return this.type===ge.STOP_MARKET||this.type===ge.STOP_LIMIT}isTakeProfitOrder(){return this.type===ge.TAKE_PROFIT_MARKET||this.type===ge.TAKE_PROFIT_LIMIT}isBuyOrder(){return this.side===pe.BUY}isSellOrder(){return this.side===pe.SELL}isTpslOrder(){return void 0!==this.raw.isPositionTpsl&&null!==this.raw.isPositionTpsl?this.raw.isPositionTpsl:this.isSetOpenSl||this.isSetOpenTp}isLiquidateOrder(){return this.raw.isLiquidate??!1}isDeleverageOrder(){return this.raw.isDeleverage??!1}isReduceOnly(){return this.raw.reduceOnly??!1}isPostOnly(){return this.timeInForce===fe.POST_ONLY}calculateValue(){if(!this.price||"0"===this.price)throw new Oe(this.type,"Cannot calculate value for market order without current price");const e=new i(this.price),t=new i(this.size);return e.multipliedBy(t)}get id(){return this.raw.id}get userId(){return this.raw.userId}get accountId(){return this.raw.accountId}get contractId(){return this.raw.contractId}get coinId(){return this.raw.coinId}get side(){return this.raw.side}get type(){return this.raw.type}get status(){return this.raw.status}get price(){return this.raw.price&&"0"!==this.raw.price?this.raw.price:void 0}get size(){return this.raw.size}get clientOrderId(){return this.raw.clientOrderId}get timeInForce(){return this.raw.timeInForce||fe.GOOD_TIL_CANCEL}get reduceOnly(){return this.raw.reduceOnly??!1}get triggerPrice(){return this.raw.triggerPrice}get triggerPriceType(){return this.raw.triggerPriceType}get expireTime(){return this.raw.expireTime}get cancelReason(){return this.raw.cancelReason}get createdTime(){return new Date(Number(this.raw.createdTime))}get updatedTime(){return new Date(Number(this.raw.updatedTime))}get triggerTime(){return this.raw.triggerTime?new Date(Number(this.raw.triggerTime)):null}get matchSequenceId(){return this.raw.matchSequenceId}get triggerPriceTime(){return this.raw.triggerPriceTime?new Date(Number(this.raw.triggerPriceTime)):null}get triggerPriceValue(){return this.raw.triggerPriceValue}get maxLeverage(){return this.raw.maxLeverage||"20"}get takerFeeRate(){return this.raw.takerFeeRate||"0.0005"}get makerFeeRate(){return this.raw.makerFeeRate||"0.0002"}get cumFillSize(){return this.raw.cumFillSize||"0"}get cumFillValue(){return this.raw.cumFillValue||"0"}get cumFillFee(){return this.raw.cumFillFee||"0"}get maxFillPrice(){return this.raw.maxFillPrice}get minFillPrice(){return this.raw.minFillPrice}get openTp(){return this.raw.openTp}get openSl(){return this.raw.openSl}get isSetOpenTp(){return this.raw.isSetOpenTp??!1}get isSetOpenSl(){return this.raw.isSetOpenSl??!1}get openTpslParentOrderId(){return this.raw.openTpslParentOrderId}formatPrice(){return this.price?this.symbol.formatPrice(this.price,"floor"):"-"}formatSize(){return this.symbol.formatSize(this.size)}formatFilledSize(){return this.symbol.formatSize(this.cumFillSize)}}class Ye{constructor(e,i){t(this,"symbol"),this.raw=i,this.symbol=e instanceof Re?e:Re.fromRaw(e)}static fromRaw(e,t){return new Ye(e,t)}static fromEmpty(e){const t=e||Re.fromRaw({});return new Ye(t,{contractId:"",contractName:"",priceChange:"",priceChangePercent:"",trades:"",size:"",value:"",high:"",low:"",open:"",close:"",highTime:"",lowTime:"",startTime:"",endTime:"",lastPrice:"",indexPrice:"",oraclePrice:"",openInterest:"",fundingRate:"",fundingTime:"",nextFundingTime:"",bestAskPrice:"",bestBidPrice:""})}get lastPriceFormatted(){return this.symbol.formatPriceFormatted(this.lastPrice)}get indexPriceFormatted(){return this.symbol.formatPriceFormatted(this.indexPrice)}get oraclePriceFormatted(){return this.symbol.formatPriceFormatted(this.oraclePrice)}get highFormatted(){return this.symbol.formatPriceFormatted(this.high)}get lowFormatted(){return this.symbol.formatPriceFormatted(this.low)}get bestAskFormatted(){return this.symbol.formatPriceFormatted(this.bestAskPrice)}get bestBidFormatted(){return this.symbol.formatPriceFormatted(this.bestBidPrice)}get volumeFormatted(){return this.symbol.formatSizeFormatted(this.volume24h)}get turnoverFormatted(){return this.symbol.formatQuoteValue(this.turnover24h)}get priceChangePercentFormatted(){const e=this.priceChangePercent;return`${e>0?"+":""}${ue(100*e,2)}%`}get contractId(){return this.raw.contractId}get contractName(){return this.raw.contractName}get priceChange(){return Number(this.raw.priceChange)}get priceChangePercent(){return Number(this.raw.priceChangePercent)}get price24hPcnt(){return this.priceChangePercent}get trades(){return Number(this.raw.trades)}get size(){return Number(this.raw.size)}get volume24h(){return this.size}get value(){return Number(this.raw.value)}get turnover24h(){return this.value}get high(){return Number(this.raw.high)}get low(){return Number(this.raw.low)}get open(){return Number(this.raw.open)}get close(){return Number(this.raw.close)}get highTime(){return Number(this.raw.highTime)}get lowTime(){return Number(this.raw.lowTime)}get startTime(){return Number(this.raw.startTime)}get endTime(){return Number(this.raw.endTime)}get lastPrice(){return Number(this.raw.lastPrice)}get indexPrice(){return Number(this.raw.indexPrice)}get oraclePrice(){return Number(this.raw.oraclePrice)}get fundingRate(){return Number(this.raw.fundingRate)}get fundingTime(){return Number(this.raw.fundingTime)}get nextFundingTime(){return Number(this.raw.nextFundingTime)}get openInterest(){return Number(this.raw.openInterest)}get bestAskPrice(){return Number(this.raw.bestAskPrice||0)}get bestBidPrice(){return Number(this.raw.bestBidPrice||0)}get openInterestUsdt(){return(this.indexPrice||0)*(this.openInterest||0)}}class je{constructor(e){this.raw=e}static fromRaw(e){return new je(e)}get userId(){return this.raw.userId}get accountId(){return this.raw.accountId}get coinId(){return this.raw.coinId}get amount(){return new i(this.raw.amount)}get amountStr(){return this.raw.amount}get legacyAmount(){return this.raw.legacyAmount}get cumDepositAmount(){return this.raw.cumDepositAmount}get cumWithdrawAmount(){return this.raw.cumWithdrawAmount}get cumTransferInAmount(){return this.raw.cumTransferInAmount}get cumTransferOutAmount(){return this.raw.cumTransferOutAmount}get cumPositionBuyAmount(){return this.raw.cumPositionBuyAmount}get cumPositionSellAmount(){return this.raw.cumPositionSellAmount}get cumFillFeeAmount(){return this.raw.cumFillFeeAmount}get cumFundingFeeAmount(){return this.raw.cumFundingFeeAmount}get cumFillFeeIncomeAmount(){return this.raw.cumFillFeeIncomeAmount}get createdTime(){return new Date(Number(this.raw.createdTime))}get updatedTime(){return new Date(Number(this.raw.updatedTime))}isSufficient(e){return this.amount.gte(e)}}class Ze{constructor(e){t(this,"ctx"),this.ctx=e}calculateCollateralStats(e){var t;const{account:r,positions:n,orders:a,metadata:o,withdraws:l,transferOuts:s,collaterals:c,tickers:u}=this.ctx,d=c.find(t=>t.coinId===e);let m=i(0),p=i((null==d?void 0:d.amount)||"0"),g=i(0);null==(t=null==n?void 0:n.filter(t=>t.coinId==e))||t.forEach(e=>{const t=u.get(e.symbol.contractName)||Ye.fromEmpty(),i=r.getEffectiveMaxLeverage(e.contractId,o),n=e.getActualLeverage(t.oraclePrice,i),a=e.getInitialMarginRequirement(t.oraclePrice,n.toNumber()),l=e.getStarkExRiskValue(t.oraclePrice),s=e.getCurrentValue(t.oraclePrice);m=m.plus(a),p=p.plus(s),g=g.plus(l)});const h=l.filter(t=>t.coinId===e&&t.isPendingCensoring()).reduce((e,t)=>e.plus(t.amount),i(0)),v=s.filter(t=>t.coinId===e&&t.isPendingForFrozen()).reduce((e,t)=>e.plus(t.amount),i(0));let f=i(0);const w=a.filter(e=>"UNTRIGGERED"!=e.status),x=$e.sort(w);let I="",R="",S=i(0),P=i(0);return x.forEach(e=>{if(e.contractId!=I||e.side!=R){I=e.contractId,R=e.side,f=f.plus(i.max(P,0)),P=i(0);const t=n.find(t=>t.contractId==e.contractId);S=i((null==t?void 0:t.openSize)||"0")}const t=i(1).div(e.maxLeverage).toFixed(6,i.ROUND_FLOOR),r=Math.max(Number(e.takerFeeRate||0),Number(e.makerFeeRate||0)),{closeSize:a,closeValue:o,openSize:l,openValue:s}=e.getFillData(S),c=u.get(e.symbol.contractName)||Ye.fromEmpty();P=P.plus(Pe({oraclePrice:c.oraclePrice,initialMarginRate:t,size:a,value:o,feeRate:r})).plus(Se({oraclePrice:c.oraclePrice,initialMarginRate:t,size:l,value:s,feeRate:r})),S=S.plus(a).plus(l)}),f=f.plus(i.max(P,0)),{totalEquity:p,totalInitialMarginRequirement:m,totalStarkExRiskValue:g,totalPendingWithdrawAmount:h,totalPendingTransferOutAmount:v,totalOrderFrozenAmount:f}}calculateAvailableBalance(e){const t=this.calculateCollateralStats(e);return i.max(0,t.totalEquity.minus(t.totalInitialMarginRequirement).minus(t.totalPendingWithdrawAmount).minus(t.totalPendingTransferOutAmount).minus(t.totalOrderFrozenAmount))}}let He=class e{constructor(e){this.raw=e}static fromRaw(t){return new e(t)}get id(){return this.raw.id}get userId(){return this.raw.userId}get accountId(){return this.raw.accountId}get coinId(){return this.raw.coinId}get amount(){return i(this.raw.amount)}get amountStr(){return this.raw.amount}get status(){return this.raw.status}get ethAddress(){return this.raw.ethAddress}get createdTime(){return new Date(Number(this.raw.createdTime))}get updatedTime(){return new Date(Number(this.raw.updatedTime))}isPendingCensoring(){return this.status===Ue}isSuccess(){return this.status===Ve}isFailed(){return this.status===qe||this.status===Ke||this.status===Ge}isPending(){return!this.isSuccess()&&!this.isFailed()}};class Xe{constructor(e){this.raw=e}static fromRaw(e){return new Xe(e)}get id(){return this.raw.id}get userId(){return this.raw.userId}get accountId(){return this.raw.accountId}get coinId(){return this.raw.coinId}get amount(){return i(this.raw.amount)}get amountStr(){return this.raw.amount}get status(){return this.raw.status}get receiverAccountId(){return this.raw.receiverAccountId}get transferReason(){return this.raw.transferReason}get createdTime(){return new Date(Number(this.raw.createdTime))}get updatedTime(){return new Date(Number(this.raw.updatedTime))}isPendingChecking(){return this.status===ze}isPendingCensoring(){return this.status===Me}isPendingForFrozen(){return this.isPendingChecking()||this.isPendingCensoring()}isSuccess(){return this.status===Ce}isFailed(){return this.status===Ae||this.status===_e||this.status===Be||this.status===De}isPending(){return!this.isSuccess()&&!this.isFailed()}}class Je{constructor(e){t(this,"params"),t(this,"oraclePrice"),t(this,"price"),t(this,"size"),t(this,"leverage"),t(this,"feeRate"),t(this,"orderbook"),this.params=e,this.oraclePrice=i(e.oraclePrice||0),this.price=i(e.price||0),this.size=i(e.size||0),this.leverage=i(e.leverage||1),this.feeRate=i(e.feeRate||0),this.orderbook=e.orderbook||[]}calcMarketPrice(e){if(!this.orderbook||0===this.orderbook.length)return this.oraclePrice;let t=this.size.abs(),r=i(0);const n="SELL"===e?[...this.orderbook].reverse():this.orderbook;for(const a of n){const e=i(a.size||0),n=i(a.price||0);if(t.lte(0))break;const o=i.min(t,e);r=r.plus(o.multipliedBy(n)),t=t.minus(o)}t.gt(0)&&(r=r.plus(t.multipliedBy(this.oraclePrice)));return r.dividedBy(this.size.abs().multipliedBy(1.02))}calcOrderOpenValue(e){return e.multipliedBy(this.size)}calcOpenPositionLoss(e){const t=e.minus(this.size.multipliedBy(this.oraclePrice));return i.max(t,0)}calcInitialMargin(){const e=i(1).dividedBy(this.leverage);return this.size.abs().multipliedBy(this.oraclePrice).multipliedBy(e)}calcOpenPositionFee(e){return e.abs().multipliedBy(this.feeRate)}calcMargin(e,t={}){const{isMarketOrder:r=!1}=t,n="LONG"===e,a=r?this.calcMarketPrice(n?"BUY":"SELL"):this.price,o=this.calcOrderOpenValue(a),l=i(1).dividedBy(this.leverage);return Se({oraclePrice:this.oraclePrice.toString(),initialMarginRate:l.toString(),size:this.size.toString(),value:o.toString(),feeRate:this.feeRate.toString()})}calcLongMargin(e={}){return this.calcMargin("LONG",e)}calcShortMargin(e={}){return this.calcMargin("SHORT",e)}getMarginDetails(e,t={}){const{isMarketOrder:i=!1}=t,r="LONG"===e,n=i?this.calcMarketPrice(r?"BUY":"SELL"):this.price,a=this.calcOrderOpenValue(n),o=this.calcOpenPositionLoss(a),l=this.calcInitialMargin(),s=this.calcOpenPositionFee(a),c=o.plus(l).plus(s);return{price:n.toString(),orderOpenValue:a.toString(),openLoss:o.toString(),initialMargin:l.toString(),fee:s.toString(),totalMargin:c.toString()}}}class Qe{static createOrdersFromRaw(e,t){const i=new Map;return t.forEach(e=>{i.set(e.contractId,e)}),e.map(e=>{const t=i.get(e.contractId);if(!t)return null;try{return $e.fromRaw(t,e)}catch(r){return null}}).filter(e=>null!==e)}static buildClosePositionOrderParams(e,t){const{price:r,size:n,type:a}=t,o=e.side===we.LONG?pe.SELL:pe.BUY,l=se(e.symbol.sizeStep),s={side:o,size:new i(n).toFixed(l,i.ROUND_DOWN),reduceOnly:!0,type:a,symbol:e.symbol.symbol,contractId:e.contractId,isPositionTpsl:!1,isSetOpenSl:!1,isSetOpenTp:!1,triggerPrice:"",triggerPriceType:ve.LAST_PRICE,confirm:!1};if(a===ge.LIMIT){if(!r)throw new Error("Price is required for limit orders.");s.price=r,s.timeInForce=fe.GOOD_TIL_CANCEL,s.triggerPriceWithType=r}else s.price="0",s.timeInForce=fe.IMMEDIATE_OR_CANCEL;return s}}function et(e){const t=e.symbolsList.find(t=>t.contractId===e.contractId);if(!t)return null;const i=e.account?xe.fromRaw(e.account):null;if(!i)return null;return{symbol:t,ticker:e.tickers.get(t.contractName)||Ye.fromEmpty(),position:e.positions.find(t=>t.contractId===e.contractId),account:i,collaterals:(e.collaterals||[]).map(e=>je.fromRaw(e)),positions:e.positions,orders:Qe.createOrdersFromRaw(e.orders,e.symbolsList),withdraws:(e.withdraws||[]).map(e=>He.fromRaw(e)),transferOuts:(e.transfers||[]).map(e=>Xe.fromRaw(e)),metadata:e.metadata,symbolsList:e.symbolsList,tickers:e.tickers}}class tt{constructor(e){t(this,"ctx"),this.ctx=e}calculateMaxOrderSize(e,t,r=!1){var n,a;if(!t)return i(0);const{symbol:o,ticker:l,positions:s,orders:c,symbolsList:u,tickers:d}=this.ctx,m=o.contractId,p=this.getCollateralStats(),g=p.totalPendingWithdrawAmount,h=p.totalPendingTransferOutAmount,v=i(p.totalEquity),f=i(p.totalInitialMarginRequirement),w=i(p.totalStarkExRiskValue);let x=v.minus(g).minus(h).minus(f);const{feeRate:I}=this.getEffectiveFeeRate(),{initialMarginRate:R}=this.getEffectiveLeverageInfo(),S=$e.sort(c.filter(e=>"UNTRIGGERED"!=e.status));let P,F="",k=i(0),y=i(0);S.forEach(t=>{if(t.contractId==m&&t.side==e)return;if(t.contractId!=(null==P?void 0:P.contractId)||t.side!=F){x=x.minus(i.max(y,0)),y=i(0),P=u.find(e=>e.contractId==t.contractId),F=t.side;const e=s.find(e=>e.contractId==t.contractId);k=i((null==e?void 0:e.openSize)||"0")}const r=i(1).div(t.maxLeverage).toFixed(6,i.ROUND_FLOOR),n=Math.max(Number(t.takerFeeRate),Number(t.makerFeeRate));if(!P)return;const{closeSize:a,closeValue:o,openSize:l,openValue:c}=t.getFillData(k),p=d.get(P.contractName)||Ye.fromEmpty();y=y.plus(Pe({oraclePrice:p.oraclePrice,initialMarginRate:r,size:a,value:o,feeRate:n})).plus(Se({oraclePrice:p.oraclePrice,initialMarginRate:r,size:l,value:c,feeRate:n})),k=k.plus(a).plus(l)}),x=x.minus(i.max(y,0));let b=i((null==(n=s.find(e=>e.contractId==m))?void 0:n.openSize)||"0");const T=new Te(o,{openSize:b.toString()}).getWorstClosePrice(null==(a=null==l?void 0:l.oraclePrice)?void 0:a.toString(),{totalEquity:v,starkExRiskValue:w,pendingWithdrawAmount:g,pendingTransferOutAmount:h},I),L=[],O={id:"0",contractId:m,side:e,price:t,type:"LIMIT",createdTime:Number.MAX_SAFE_INTEGER,triggerTime:Number.MAX_SAFE_INTEGER};S.forEach(t=>{if(t.contractId!=m||t.side!=e)return;if($e.comparator(O,t)<0)return void L.push(t.raw);const r=i(1).div(t.maxLeverage).toFixed(6,i.ROUND_FLOOR),n=Math.max(Number(t.takerFeeRate),Number(t.makerFeeRate)),{closeSize:a,closeValue:o,openSize:s,openValue:c}=t.getFillData(b);x=x.minus(Pe({oraclePrice:l.oraclePrice,initialMarginRate:r,size:a,value:o,feeRate:n})).minus(Se({oraclePrice:l.oraclePrice,initialMarginRate:r,size:s,value:c,feeRate:n})),b=b.plus(a).plus(s)});let E=i(0);if((e==Ee&&b.lt(0)||e==Ne&&b.gt(0))&&(E=b.abs()),E.gt(0)){if(e==Ee&&i(t).gte(T)||e==Ne&&i(t).lt(T))return i(0);if(!tt.checkCloseOrderIsValid(o,l.oraclePrice.toString(),R,b,x,L,e,E,E.multipliedBy(t),I)){let r=i(0),n=E;for(;n.minus(r).gt(i(o.stepSize));){const a=i(n.plus(r).dividedBy(2).toFixed(se(o.stepSize),i.ROUND_FLOOR));tt.checkCloseOrderIsValid(o,l.oraclePrice.toString(),R,b,x,L,e,a,a.multipliedBy(t),I)?r=a:n=a}return r}e==Ee?x=x.minus(Pe({oraclePrice:l.oraclePrice,initialMarginRate:R,size:E,value:E.multipliedBy(t),feeRate:I})):e==Ne&&(x=x.minus(Pe({oraclePrice:l.oraclePrice,initialMarginRate:R,size:E.negated(),value:E.multipliedBy(t).negated(),feeRate:I})))}if(r)return E;L.forEach(e=>{const t=i(1).div(e.maxLeverage||"20").toFixed(6,i.ROUND_FLOOR),r=Math.max(Number(e.takerFeeRate||"0"),Number(e.makerFeeRate||"0")),n=$e.fromRaw(o,e),{openSize:a,openValue:s}=n.getFillData(i(0));x=x.minus(Se({oraclePrice:l.oraclePrice,initialMarginRate:t,size:a,value:s,feeRate:r}))});let N=i(0);e==Ee?N=i.max(i(t).minus(null==l?void 0:l.oraclePrice),0).plus(i(l.oraclePrice).multipliedBy(R)).plus(i(t).multipliedBy(I)):e==Ne&&(N=i.max(i(null==l?void 0:l.oraclePrice).minus(t),0).plus(i(l.oraclePrice).multipliedBy(R)).plus(i(t).multipliedBy(I)));let z=i(0);return x.gt(0)&&(z=i(x.dividedBy(N).toFixed(se(o.stepSize),i.ROUND_FLOOR))),z.plus(E)}calculateMaxMarketOrderSize(e,t,i){const r="BUY"==e?i.ask1:i.bid1;return this.calculateMaxOrderSize(e,r,t)}calculateOrderCost(e,t,r){var n;const{symbol:a,ticker:o,positions:l,orders:s}=this.ctx,c=a.contractId;let u=i((null==(n=l.find(e=>e.contractId==c))?void 0:n.openSize)||"0");const d={id:"0",contractId:c,side:e,price:t,type:"LIMIT",createdTime:Number.MAX_SAFE_INTEGER,triggerTime:Number.MAX_SAFE_INTEGER,size:r,status:"OPEN",cumFailSize:"0",cumFillSize:"0"};$e.sort(s.filter(t=>"UNTRIGGERED"!=t.status&&t.contractId==c&&t.side==e)).forEach(e=>{const t=$e.fromRaw(a,e instanceof $e?e.raw:e),{closeSize:i,openSize:r}=t.getFillData(u);u=u.plus(i).plus(r)});const m=$e.fromRaw(a,d),{openSize:p,closeSize:g}=m.getFillData(u),{feeRate:h}=this.getEffectiveFeeRate(),{initialMarginRate:v}=this.getEffectiveLeverageInfo(),f=Se({oraclePrice:o.oraclePrice,initialMarginRate:v,size:p,value:i(p).multipliedBy(t),feeRate:h}),w=Pe({oraclePrice:o.oraclePrice,initialMarginRate:v,size:g,value:i(g).multipliedBy(t),feeRate:h});return i.max(f.plus(w),0)}getEffectiveFeeRate(){var e;const{account:t,symbol:i,metadata:r}=this.ctx,n=i.contractId;let a,o;if(t)({takerFeeRate:a,makerFeeRate:o}=t.getEffectiveFeeRate(n,r));else{const t=null==(e=r.contractList)?void 0:e.find(e=>e.contractId===n);a=null==t?void 0:t.defaultTakerFeeRate,o=null==t?void 0:t.defaultMakerFeeRate}return{takerFeeRate:a||"0",makerFeeRate:o||"0",feeRate:Math.max(Number(a),Number(o))}}getEffectiveLeverageInfo(){var e;const{account:t,symbol:r,metadata:n}=this.ctx,a=r.contractId;let o;if(t)o=t.getEffectiveMaxLeverage(a,n);else{const t=null==(e=n.contractList)?void 0:e.find(e=>e.contractId===a);o=Number(null==t?void 0:t.defaultLeverage)}return{maxLeverage:o,initialMarginRate:i(1).div(o||20).toFixed(6,i.ROUND_FLOOR)}}calculateLiquidationPrice(e,t,r){var n,a;if(!t||!r)return"0";const{symbol:o,ticker:l,positions:s}=this.ctx,c=o.contractId,u=this.getCollateralStats(),d=u.totalPendingWithdrawAmount,m=u.totalPendingTransferOutAmount,p=i(u.totalEquity),g=i(u.totalStarkExRiskValue),{feeRate:h}=this.getEffectiveFeeRate(),v=i((null==(n=s.find(e=>e.contractId==c))?void 0:n.openSize)||"0"),f=i(r).dividedBy("BUY"==e?1:-1),w=f.multipliedBy(t),x=w.multipliedBy(h).abs().negated(),I=null==(a=null==l?void 0:l.oraclePrice)?void 0:a.toString(),R=tt.calculateCollateralTotalEquityAfterFill({oraclePrice:I,collateralTotalEquity:p,fillSize:f,fillValue:w,fillFee:x}),S=tt.calculateCollateralStarkExRiskValueAfterFill({contract:o,oraclePrice:I,positionOpenSize:v,collateralStarkExRiskValue:g,fillSize:f}),P=v.plus(f),F=new Te(o,{openSize:P.toString()}).getLiquidationPrice(I,{totalEquity:R,starkExRiskValue:S,pendingWithdrawAmount:d,pendingTransferOutAmount:m});return String(F)}getCollateralStats(){const{account:e,symbol:t}=this.ctx,r=t.quoteCoinId;if(e){return new Ze(this.ctx).calculateCollateralStats(r)}return{totalEquity:i(0),totalInitialMarginRequirement:i(0),totalStarkExRiskValue:i(0),totalPendingWithdrawAmount:i(0),totalPendingTransferOutAmount:i(0),totalOrderFrozenAmount:i(0)}}static checkCloseOrderIsValid(e,t,r,n,a,o,l,s,c,u){let d=!0,m=i(0),p=i(0);if(l==Ee)m=i(a).minus(Pe({oraclePrice:t,initialMarginRate:r,size:s,value:c,feeRate:u})),p=i(n).plus(s);else{if(l!=Ne)return d=!1,d;m=i(a).minus(Pe({oraclePrice:t,initialMarginRate:r,size:i(s).negated(),value:i(c).negated(),feeRate:u})),p=i(n).minus(s)}return o.forEach(n=>{if(!d)return;let a=i(0);if(a=["PENDING","OPEN","CANCELING"].includes(n.status)?i(n.size).minus(n.cumFailSize).minus(n.cumFillSize):["FILLED","CANCELED"].includes(n.status)?i(n.cumMatchSize).minus(n.cumFailSize).minus(n.cumFillSize):i(0),a.lte(0))return;let o=i(0);o="0"==n.price?i(a.multipliedBy(i(n.marketLimitValue)).dividedBy(i(n.size).toFixed(se(e.stepSize),"BUY"==n.side?i.ROUND_CEIL:i.ROUND_FLOOR))):a.multipliedBy(i(n.price));let s=i(0);s="BUY"==n.side&&p.lt(0)?i.min(p.negated(),a):"SELL"==n.side&&p.gt(0)?i.max(p.negated(),a.negated()):i(0);let c=i(0);c="BUY"==n.side?a.minus(s):a.negated().minus(s);const g=i(s.multipliedBy(o).dividedBy(a).toFixed(se(e.stepSize),"BUY"==n.side?i.ROUND_FLOOR:i.ROUND_CEIL));let h=i(0);h="BUY"==n.side?o.minus(g):o.negated().minus(g),m=m.plus(Pe({oraclePrice:t,initialMarginRate:r,size:s,value:g,feeRate:u})).plus(Se({oraclePrice:t,initialMarginRate:r,size:c,value:h,feeRate:u})),0!=c.comparedTo(0)&&m.comparedTo(0)<0?d=!1:p=l==Ee?p.plus(s):p.minus(s)}),d}static calculateCollateralTotalEquityAfterFill({oraclePrice:e,collateralTotalEquity:t,fillSize:r,fillValue:n,fillFee:a}){return i(t).minus(n).plus(i(r).multipliedBy(e)).plus(a)}static calculateCollateralStarkExRiskValueAfterFill({contract:e,oraclePrice:t,positionOpenSize:r,collateralStarkExRiskValue:n,fillSize:a}){var o,l;const s=i(r).multipliedBy(t),c=i((null==(o=e.getRiskTier(s.toString()))?void 0:o.starkExRisk)||0).div(i(2).pow(32)),u=s.abs().multipliedBy(c),d=i(r).plus(a).multipliedBy(t),m=i((null==(l=e.getRiskTier(d.toString()))?void 0:l.starkExRisk)||0).div(i(2).pow(32)),p=d.abs().multipliedBy(m);return i(n).minus(u).plus(p)}}class it{static getExecutionPrice(e,t,i,r){if([ge.LIMIT,ge.STOP_LIMIT].includes(e))return String(i);const{ask1:n="0",bid1:a="0"}=r||{};return String(t===Ee?n:a)}static calculateRiskLimitMaxSize(e,t,r,n){if(!t||!r||Number(r)<=0)return 1/0;const a=[...t].slice().sort((e,t)=>Number(e.maxLeverage)-Number(t.maxLeverage)).find(t=>Number(t.maxLeverage)>=e);if(!a)return 1/0;const o=a.positionValueUpperBound;if("79228162514264337593543"===o)return 1/0;const l=i(o).dividedBy(r);return Number(ue(l,n))||0}static getMaxPositionSizeLimit(e){return!e||Number(e)<=0?1/0:Number(e)}static calculateCost(e,t){const{size:r,price:n,side:a,type:o}=t,l=this.getExecutionPrice(o,a,n,e.orderBook),s=et(e);if(!s)return i(0);return new tt(s).calculateOrderCost(a,l,String(r))}static calculateMaxSize(e,t){var r,n;const{type:a,side:o,price:l,reduceOnly:s}=t,c=e.symbolsList.find(t=>t.contractId===e.contractId);if(!c)return i(0);const u=this.getExecutionPrice(a,o,l,e.orderBook);let d;if(e.account)d=xe.fromRaw(e.account).getEffectiveMaxLeverage(e.contractId,e.metadata);else{const t=null==(n=null==(r=e.metadata)?void 0:r.contractList)?void 0:n.find(t=>t.contractId===e.contractId);d=Number(null==t?void 0:t.defaultLeverage)}let m=u;if([ge.MARKET,ge.STOP_MARKET].includes(a)){const t=e.tickers.get(c.contractName);t&&Number(t.oraclePrice)>0&&(m=String(t.oraclePrice))}const p=this.calculateRiskLimitMaxSize(d,c.riskTierList,m,c.sizePrecision),g=this.getMaxPositionSizeLimit(c.maxPositionSize);let h=i(0);const v=et(e);if(v){const t=new tt(v);if([ge.LIMIT,ge.STOP_LIMIT].includes(a))h=t.calculateMaxOrderSize(o,String(l),!!s);else{const{ask1:i="0",bid1:r="0"}=e.orderBook||{};h=t.calculateMaxMarketOrderSize(o,!!s,{ask1:String(i),bid1:String(r)})}}const f=Math.max(Math.min(h.toNumber()||0,p,g),0);return i(f)}static calculateMargin(e){const{side:t,isMarketOrder:i,...r}=e,n=t===Ee||"LONG"===t?"LONG":"SHORT";return new Je({...r,orderbook:r.orderBook}).calcMargin(n,{isMarketOrder:i})}}function rt(e){var t,i;const n=r(),a=n.position||[],o=n.order||[],l=n.metadata;let s=n.contractList.find(t=>t.contractId===e);const c=new Map;n.tickers.forEach(e=>{let t=n.contractList.find(t=>t.contractId===e.contractId);c.set(null==t?void 0:t.contractName,new Ye(Re.fromRaw(t),e))});let u=o.map(e=>e);return{positions:a.map(e=>new Te(n.contractList.find(t=>t.contractId===e.contractId),e))||[],metadata:l,orders:u||[],account:n.userInfo,collaterals:n.collateral||[],withdraws:n.withdraw||[],transfers:n.transferOut||[],symbolsList:(null==(i=null==(t=(null==l?void 0:l.contractList)||[])?void 0:t.map)?void 0:i.call(t,e=>Re.fromRaw(e)))||[],tickers:c,orderBook:{ask1:(null==s?void 0:s.lastPrice)||"0",bid1:(null==s?void 0:s.lastPrice)||"0"}}}const nt=e=>{var t,n,a;const o=r(),l=o.userInfo,s=o.metadata,c=null==(t=null==l?void 0:l.contractIdToTradeSetting)?void 0:t[e],u=null==(a=null==(n=null==s?void 0:s.contractList)?void 0:n.find)?void 0:a.call(n,t=>t.contractId===e),d=null==l?void 0:l.defaultTradeSetting;return(null==c?void 0:c.isSetFeeRate)?{takerFeeRate:null==c?void 0:c.takerFeeRate,makerFeeRate:null==c?void 0:c.makerFeeRate}:(null==c?void 0:c.isSetFeeDiscount)?{takerFeeRate:i((null==u?void 0:u.defaultTakerFeeRate)||"0").multipliedBy(null==c?void 0:c.takerFeeDiscount).toString(),makerFeeRate:i((null==u?void 0:u.defaultMakerFeeRate)||"0").multipliedBy(null==c?void 0:c.makerFeeDiscount).toString()}:(null==d?void 0:d.isSetFeeRate)?{takerFeeRate:null==d?void 0:d.takerFeeRate,makerFeeRate:null==d?void 0:d.makerFeeRate}:(null==d?void 0:d.isSetFeeDiscount)?{takerFeeRate:i((null==u?void 0:u.defaultTakerFeeRate)||"0").multipliedBy(null==d?void 0:d.takerFeeDiscount).toString(),makerFeeRate:i((null==u?void 0:u.defaultMakerFeeRate)||"0").multipliedBy(null==d?void 0:d.makerFeeDiscount).toString()}:{takerFeeRate:(null==u?void 0:u.defaultTakerFeeRate)||"0",makerFeeRate:(null==u?void 0:u.defaultMakerFeeRate)||"0"}},at=e=>{var t,i;const n=r(),a=n.userInfo,o=n.metadata,l=null==(t=null==a?void 0:a.contractIdToTradeSetting)?void 0:t[e],s=null==(i=null==o?void 0:o.contractList)?void 0:i.find(t=>t.contractId===e),c=null==a?void 0:a.defaultTradeSetting;return(null==l?void 0:l.isSetMaxLeverage)?null==l?void 0:l.maxLeverage:(null==c?void 0:c.isSetMaxLeverage)?null==c?void 0:c.maxLeverage:null==s?void 0:s.defaultLeverage};function ot(e,t,r){if(null==t||new i(t).isZero())return new i(e).toFixed();const n=new i(e),a=new i(t),o=function(e){const t=new i(e||0);if(t.gt(1)){return-ht(new i(1).div(t))}return ht(t)}(t);return n.div(a).integerValue(r).times(a).times(new i(10).pow(o)).dp(0,i.ROUND_FLOOR).div(new i(10).pow(o)).toFixed()}function lt(e){const t=e.leverage||at(e.contractId),r=nt(e.contractId),n={side:e.side||"BUY",oraclePrice:e.oraclePrice||"0",price:e.price||e.oraclePrice||"0",size:e.size||"0",leverage:t||0,feeRate:e.feeRate||i.max(r.takerFeeRate||0,(null==r?void 0:r.makerFeeRate)||0).toFixed(),isMarketOrder:e.isMarketOrder||!e.price};return new Je(n).calcMargin("BUY"===e.side?"LONG":"SHORT",{isMarketOrder:n.isMarketOrder})}function st(e){var t,n;const a=r(),o={...e},l=a.userInfo;if(!l)return i(0);const s=new Map;a.tickers.forEach(e=>{let t=a.contractList.find(t=>t.contractId===e.contractId);s.set(null==t?void 0:t.contractName,new Ye(Re.fromRaw(t),e))});const c=a.contractList.find(t=>t.contractId===e.contractId),u={contractId:e.contractId,metadata:a.metadata,account:l,positions:(null==(t=a.position||[])?void 0:t.map(e=>new Te(a.contractList.find(t=>t.contractId===e.contractId),e)))||[],orders:a.order||[],collaterals:a.collateral||[],withdraws:a.withdraw||[],transfers:a.transferOut||[],symbolsList:(null==(n=a.contractList)?void 0:n.map(e=>Re.fromRaw(e)))||[],tickers:s,orderBook:{ask1:(null==c?void 0:c.lastPrice)||"0",bid1:(null==c?void 0:c.lastPrice)||"0"}};return it.calculateMaxSize(u,o)}function ct(e){const{maxQty:t,ratio:r,stepSize:n}=e,a=i(t).multipliedBy(r).dividedBy(100),o=ht(n);return a.times(new i(10).pow(o)).dp(0,i.ROUND_FLOOR).div(new i(10).pow(o)).toFixed()}function ut(e){var t;const i=r(),n=i.userInfo;if(!i.metadata||!n)return"0";const a=i.metadata,o=n?xe.fromRaw(n):null;if(!o)return"0";const l=(null==a?void 0:a.contractList)||[],s=i.order||[],c=i.collateral||[],u=i.withdraw||[],d=i.transferOut||[],m=(null==l?void 0:l.map(e=>Re.fromRaw(e)))||[],p=(c||[]).map(e=>je.fromRaw(e)),g=new Map;i.tickers.forEach(e=>{let t=i.contractList.find(t=>t.contractId===e.contractId);g.set(null==t?void 0:t.contractName,new Ye(Re.fromRaw(t),e))});let h=i.contractList.find(t=>t.contractId===e.contractId);if(!h)return"0";return new tt({account:o,collaterals:p||[],positions:(null==(t=i.position||[])?void 0:t.map(e=>new Te(i.contractList.find(t=>t.contractId===e.contractId),e)))||[],orders:(s||[]).map(e=>$e.fromRaw(i.contractList.find(t=>t.contractId===e.contractId),e))||[],withdraws:(u||[]).map(e=>He.fromRaw(e)),transferOuts:(d||[]).map(e=>Xe.fromRaw(e)),metadata:a,symbolsList:m,tickers:g,symbol:m.find(t=>t.contractId===e.contractId),ticker:g.get(null==h?void 0:h.contractName)}).calculateLiquidationPrice(e.side,String(e.price),String(e.size))}function dt(e){var t,i,n,a,o,l;const s=rt(e),c=r(),u=c.metadata;if(!u)return"0";const d=(null==(t=c.metadata)?void 0:t.contractList)||[];if(!d)return"0";const m=s.tickers||[],p=null==(i=s.symbolsList)?void 0:i.find(t=>t.contractId===e);if(!p)return"0";const g=null==(n=c.position)?void 0:n.find(t=>t.contractId===e),h=c.userInfo,v=c.order||[],f=c.collateral||[],w=new Te(p,g),x=(null==d?void 0:d.map(e=>Re.fromRaw(e)))||[];if(!(null==(a=null==w?void 0:w.symbol)?void 0:a.contractName))return"0";const I=null==m?void 0:m.get((null==(o=null==w?void 0:w.symbol)?void 0:o.contractName)||"");if(!I)return"0";if(!w)return{liqPrice:0,liqPriceFormatted:"-"};const R=h?xe.fromRaw(h):null,S=(f||[]).map(e=>je.fromRaw(e));if(!R)return{liqPrice:0,liqPriceFormatted:"-"};const P=c.withdraw||[],F=c.transferOut||[],k=new Ze({account:R,collaterals:S||[],positions:(null==(l=c.position||[])?void 0:l.map(e=>new Te(c.contractList.find(t=>t.contractId===e.contractId),e)))||[],orders:(v||[]).map(e=>$e.fromRaw(c.contractList.find(t=>t.contractId===e.contractId),e))||[],withdraws:(P||[]).map(e=>He.fromRaw(e)),transferOuts:(F||[]).map(e=>Xe.fromRaw(e)),metadata:u,symbolsList:x,tickers:m}).calculateCollateralStats(null==p?void 0:p.quoteCoinId);return w.getLiquidationPrice(null==I?void 0:I.oraclePrice,{totalEquity:null==k?void 0:k.totalEquity,starkExRiskValue:null==k?void 0:k.totalStarkExRiskValue,pendingWithdrawAmount:null==k?void 0:k.totalPendingWithdrawAmount,pendingTransferOutAmount:null==k?void 0:k.totalPendingTransferOutAmount})}function mt(e,t){var i,n,a;const o=r(),l=o.userInfo;if(!o.metadata||!l)return"0";const s=o.metadata,c=l?xe.fromRaw(l):null;if(!c)return"0";const u=t||(null==(n=null==(i=null==s?void 0:s.contractList)?void 0:i.find(t=>t.contractId===e))?void 0:n.quoteCoinId),d=(null==s?void 0:s.contractList)||[],m=o.order||[],p=o.collateral||[],g=o.withdraw||[],h=o.transferOut||[],v=(null==d?void 0:d.map(e=>Re.fromRaw(e)))||[],f=(p||[]).map(e=>je.fromRaw(e)),w=new Map;o.tickers.forEach(e=>{let t=o.contractList.find(t=>t.contractId===e.contractId);w.set(null==t?void 0:t.contractName,new Ye(Re.fromRaw(t),e))});return new Ze({account:c,collaterals:f||[],positions:(null==(a=o.position||[])?void 0:a.map(e=>new Te(o.contractList.find(t=>t.contractId===e.contractId),e)))||[],orders:(m||[]).map(e=>$e.fromRaw(o.contractList.find(t=>t.contractId===e.contractId),e))||[],withdraws:(g||[]).map(e=>He.fromRaw(e)),transferOuts:(h||[]).map(e=>Xe.fromRaw(e)),metadata:s,symbolsList:v,tickers:w}).calculateAvailableBalance(t||u)}function pt(e,t){var i,n,a,o,l,s,c,u;const d=rt(e),m=r(),p={unrealizedPnl:"0",unrealizedPnlRoe:"0",unrealizedPnlRoeFormatted:"0%"};if(!m.metadata)return p;if(!((null==(i=m.metadata)?void 0:i.contractList)||[]))return p;const g=d.tickers||[],h=null==(n=d.symbolsList)?void 0:n.find(t=>t.contractId===e);if(!h)return p;const v=null==(a=m.position)?void 0:a.find(t=>t.contractId===e);if(!v)return p;const f=new Te(h,v);if(!(null==(o=null==f?void 0:f.symbol)?void 0:o.contractName))return p;const w=null==g?void 0:g.get((null==(l=null==f?void 0:f.symbol)?void 0:l.contractName)||"");if(!w)return p;if(!f)return p;const x=at(e),I=(null==w?void 0:w.lastPrice)||(null==w?void 0:w.oraclePrice)||0;return{unrealizedPnl:(null==(c=null==(s=null==f?void 0:f.getUnrealizedPnl)?void 0:s.call(f,I||"0"))?void 0:c.toFixed())||"0",unrealizedPnlRoe:(null==(u=f.getUnrealizedPnlRoe(I||"0",x||"1"))?void 0:u.toFixed())||"0",unrealizedPnlRoeFormatted:f.getUnrealizedPnlRoeFormatted(I||"0",x||"1")}}function gt(e,t,n){var a,o,l,s,c;const u=rt(e),d=r(),m=d.metadata,p=i(0);if(!m)return p;if(!((null==(a=d.metadata)?void 0:a.contractList)||[]))return p;const g=u.tickers||[],h=null==(o=u.symbolsList)?void 0:o.find(t=>t.contractId===e);if(!h)return p;const v=null==(l=d.position)?void 0:l.find(t=>t.contractId===e);if(!v)return p;const f=new Te(h,v);if(!(null==(s=null==f?void 0:f.symbol)?void 0:s.contractName))return p;if(!(null==g?void 0:g.get((null==(c=null==f?void 0:f.symbol)?void 0:c.contractName)||"")))return p;if(!f)return p;const w=n||at(e),x=t;return f.getInitialMarginRequirement(x,w||"0")}function ht(e){const t=e.toString();return t.includes(".")?t.length-t.indexOf(".")-1:0}function vt(e){const t=St.getSymbolModel(e),r=(null==t?void 0:t.tickSize)||0,n=new i(r);if(n.gt(1)){return-ht(new i(1).div(n))}return ht(n)}function ft(e){const t=St.getSymbolModel(e),r=(null==t?void 0:t.stepSize)||0,n=new i(r);if(n.gt(1)){return-ht(new i(1).dividedBy(n))}return ht(n)}function wt(e,t){return i(t.createdTime||0).minus(e.createdTime||0).toNumber()}function xt(e,t){const r={BUY:1,SELL:2};let n=0;const a=new i(e.contractId),o=new i(t.contractId);if(n=a.isNaN()||o.isNaN()?e.contractId.localeCompare(t.contractId):a.comparedTo(o)||0,0!==n)return n;const l=r[e.side],s=r[t.side];if(null!=l&&null!=s&&(n=l-s,0!==n))return n;const c=new i(e.price).isZero(),u=new i(t.price).isZero();if(n=Number(c)-Number(u),0!==n)return n;const d=new i(e.price),m=new i(t.price);var p;if(d.isNaN()||m.isNaN()||(n="BUY"===(p=e.side)||"buy"===p?m.comparedTo(d)||0:d.comparedTo(m)||0),0!==n)return n;const g=new i(It(e.type)?e.triggerTime:e.createdTime),h=new i(It(t.type)?t.triggerTime:t.createdTime);if(g.isNaN()||h.isNaN()||(n=h.comparedTo(g)||0),0!==n)return n;const v=new i(e.id),f=new i(t.id);return n=v.isNaN()||f.isNaN()?e.id.localeCompare(t.id):v.comparedTo(f)||0,n}function It(e){return"CONDITION"===e||"conditional"===e}function Rt(e){var t;const r=St.getSymbolModel(e.contractId),n=e.orderModel,a=ht((null==(t=St.getCoinModel((null==r?void 0:r.quoteCoinId)||""))?void 0:t.stepSize)||"0");let o=new i(0);if(o="PENDING"===n.status||"OPEN"===n.status||"CANCELING"===n.status?new i(n.size||0).minus(n.cumFailSize||0).minus(n.cumFillSize||0):new i(n.cumMatchSize||0).minus(n.cumFailSize||0).minus(n.cumFillSize||0),o.isZero())return{openSize:new i("0"),closeSize:new i("0"),openValue:new i("0"),closeValue:new i("0")};let l=new i(0);n.isWithoutMatch?(l=o.times(new i((null==n?void 0:n.withoutMatchFillValue)||0)).div((null==n?void 0:n.withoutMatchFillSize)||0),l="BUY"===n.side?l.decimalPlaces(Number(a),i.ROUND_CEIL):l.decimalPlaces(Number(a),i.ROUND_FLOOR)):i(n.price).isZero()?(l=o.times(new i((null==n?void 0:n.marketLimitValue)||0)).div((null==n?void 0:n.size)||0),l="BUY"===n.side?l.decimalPlaces(Number(a),i.ROUND_CEIL):l.decimalPlaces(Number(a),i.ROUND_FLOOR)):l=o.times(n.price||0);let s=new i(0);"BUY"===n.side&&new i(e.positionOpenSize).lt(0)?s=i.min(o,new i(e.positionOpenSize).negated()):"SELL"===n.side&&new i(e.positionOpenSize).gt(0)&&(s=i.max(o.negated(),new i(e.positionOpenSize).negated()));let c=new i(0);c="BUY"===n.side?o.minus(s):o.negated().minus(s);let u=s.times(l).div(o);u=u.decimalPlaces(Number(a||0),i.ROUND_FLOOR);return{openSize:c,closeSize:s,openValue:"BUY"===n.side?l.minus(u):l.negated().minus(u),closeValue:u}}class St{static getUserInfo(){return r().userInfo}static getSymbolModel(e){const t=r();return((null==t?void 0:t.contractList)||[]).find(t=>t.contractId===e)}static getCoinModel(e){var t;const i=r().metadata;return null==(t=null==i?void 0:i.coinList)?void 0:t.find(t=>t.coinId===e)}static getPositionAvgEntryPrice(e,t,r){const n=new i(e),a=new i(t);if(n.isZero())return new i(0);const o=a.div(n);return n.gt(0)?o.decimalPlaces(r,i.ROUND_CEIL):o.decimalPlaces(r,i.ROUND_FLOOR)}static getPositionRiskTier(e,t){var n;const a=(null==(n=r().contractList.find(e=>e.contractId===t))?void 0:n.riskTierList)||[],o=new i(e).abs();for(const r of a)if(new i(o).lte(r.positionValueUpperBound))return r;return a.length>0?a[a.length-1]:null}static getOpenMaxLeverage(e){var t,i;const n=r(),a=n.userInfo,o=n.metadata,l=null==(t=null==a?void 0:a.contractIdToTradeSetting)?void 0:t[e],s=null==(i=null==o?void 0:o.contractList)?void 0:i.find(t=>t.contractId===e),c=null==a?void 0:a.defaultTradeSetting;return(null==l?void 0:l.isSetMaxLeverage)?null==l?void 0:l.maxLeverage:(null==c?void 0:c.isSetMaxLeverage)?null==c?void 0:c.maxLeverage:null==s?void 0:s.defaultLeverage}static getPositionMaxLeverage(e,t){r();const n=St.getOpenMaxLeverage(e),a=St.getPositionRiskTier(t,e);if(null==a)return n;return le.min(new i(n||0),new i(a.maxLeverage)).decimalPlaces(0,i.ROUND_FLOOR).toString()}static getInitialMarginRateWithMaxLeverage(e){const t=le.toDecimal(e);return t.lt(new i(1))?"1":le.floor(le.divide(new i(1),t),6)}static getPositionInitialMarginRequirement(e,t){return le.multiply(t,e)}static getPositionStarkExRiskRate(e,t){const r=St.getPositionRiskTier(t,e);if(null!==r){const e=new i(2).pow(32);return le.divide(le.toDecimal(r.starkExRisk),e)}return"0"}static getPositionStarkExRiskValue(e,t){return le.multiply(e,t)}static _getPositionLiquidatePriceInternal(e){let t=St.getSymbolModel(e.contractId),r=new i(e.openSize),n=new i(e.oraclePrice),a=new i(e.collateralTotalEquity),o=new i(e.collateralStarkExRiskValue),l=new i(e.fixStarkExRiskRate);if(r.isZero())return new i(0);if(r.gt(0)){if(l.gt(0)&&l.lt(1)){const s=r.multipliedBy(l.plus(1)),c=n.multipliedBy(s).minus(a.minus(o)),u=vt(e.contractId);let d=c.div(s).decimalPlaces(u,i.ROUND_FLOOR);return d.multipliedBy(s).isEqualTo(c)&&(d=d.minus(le.toDecimal((null==t?void 0:t.tickSize)||0))),d}return"0"}if(r.lt(0)){if(l.gt(0)){const s=r.times(l.plus(1)),c=n.times(s).minus(a.minus(o)),u=vt(e.contractId),d=c.div(s).decimalPlaces(u,i.ROUND_FLOOR);return d.times(s).isEqualTo(c)?d.plus((null==t?void 0:t.tickSize)||0):d}return l.gte(1),"0"}return"0"}static getPositionLiquidatePrice(e){const t=St.getSymbolModel(e.contractId),r=new i(e.oraclePrice),n=new i(e.positionOpenSize);let a=new i(e.collateralTotalEquity);const o=new i(e.collateralStarkExRiskValue),l=new i(e.collateralPendingWithdrawAmount),s=new i(e.collateralPendingTransferOutAmount);a=a.minus(l).minus(s);const c=n.multipliedBy(r),u=St.getPositionStarkExRiskValue(c.toFixed(),St.getPositionStarkExRiskRate((null==e?void 0:e.contractId)||"",c.toFixed())),d=(null==t?void 0:t.riskTierList)||[];if(n.gt(0)){if(0===d.length)return"0";for(let t=d.length-1;t>=0;t--){const l=d[t],s=t>0?d[t-1]:null,m=new i((null==s?void 0:s.positionValueUpperBound)||"0"),p=new i(l.positionValueUpperBound),g=new i(l.starkExRisk).dividedBy(new i(2).pow(32)),h=St._getPositionLiquidatePriceInternal({contractId:e.contractId,oraclePrice:r.toFixed(),collateralTotalEquity:a.toFixed(),collateralStarkExRiskValue:o.minus(u).plus(c.abs().times(g)).toFixed(),fixStarkExRiskRate:g.toFixed(),openSize:n.toFixed()}),v=new i(h).multipliedBy(n).abs();if(new i(h).lte(0))return h;if(!v.lte(m)){if(v.lte(p))return h;{const t=vt(e.contractId);return p.dividedBy(n.abs()).decimalPlaces(t,i.ROUND_FLOOR)}}}return"0"}if(n.lt(0)){for(let l=0;l<d.length;l++){const s=d[l],m=l>0?d[l-1]:null,p=new i((null==m?void 0:m.positionValueUpperBound)||"0"),g=new i(s.positionValueUpperBound),h=new i(s.starkExRisk).dividedBy(new i(2).pow(32)),v=St._getPositionLiquidatePriceInternal({contractId:e.contractId,oraclePrice:r.toFixed(),collateralTotalEquity:a.toFixed(),collateralStarkExRiskValue:o.minus(u).plus(c.abs().times(h)).toFixed(),fixStarkExRiskRate:h.toFixed(),openSize:n.toFixed()}),f=new i(v).times(n).abs();if(f.lte(p)){const r=p.div(n).decimalPlaces(vt(e.contractId),i.ROUND_CEIL);return r.times(n).abs().isEqualTo(f)?r.plus(new i((null==t?void 0:t.tickSize)||0)):r}if(f.lte(g))return v}return St._getPositionLiquidatePriceInternal({contractId:e.contractId,oraclePrice:r.toFixed(),collateralTotalEquity:a.toFixed(),collateralStarkExRiskValue:o.toFixed(),fixStarkExRiskRate:"1",openSize:n.toFixed()})}return"0"}static getMaxTradeFeeRate(e){var t;const r=St.getUserInfo(),n=St.getSymbolModel(e);let a=new i((null==n?void 0:n.defaultTakerFeeRate)||0),o=new i((null==n?void 0:n.defaultMakerFeeRate)||0);if(!(null==r?void 0:r.id)||!(null==n?void 0:n.contractId))return i.max(a,o);const l=null==(t=null==r?void 0:r.contractIdToTradeSetting)?void 0:t[e];if(l){if(null==l?void 0:l.isSetFeeRate)return a=new i((null==l?void 0:l.takerFeeRate)||0),o=new i((null==l?void 0:l.makerFeeRate)||0),i.max(a,o);if(null==l?void 0:l.isSetFeeDiscount)return a=a.multipliedBy(new i((null==l?void 0:l.takerFeeDiscount)||0)),o=o.multipliedBy(new i((null==l?void 0:l.makerFeeDiscount)||0)),i.max(a,o)}const s=null==r?void 0:r.defaultTradeSetting;return(null==s?void 0:s.isSetFeeRate)?(a=new i((null==s?void 0:s.takerFeeRate)||0),o=new i((null==s?void 0:s.makerFeeRate)||0),i.max(a,o)):(null==s?void 0:s.isSetFeeDiscount)?(a=a.multipliedBy(new i((null==s?void 0:s.takerFeeDiscount)||0)),o=o.multipliedBy(new i((null==s?void 0:s.makerFeeDiscount)||0)),i.max(a,o)):i.max(a,o)}static _getOpenOrderFrozenAmount(e){const t=new i(e.oraclePrice||"0"),r=new i(e.initialMarginRate||"0"),n=new i(e.orderOpenSize||"0"),a=new i(e.orderOpenValue||"0"),o=new i(e.feeRate||"0"),l=i.max(a.minus(t.times(n)),new i(0)),s=t.times(r).times(n.abs()),c=a.abs().times(o);return l.plus(s).plus(c).toFixed()}static _getCloseOrderFrozenAmount(e){const t=new i(e.oraclePrice||"0"),r=new i(e.initialMarginRate||"0"),n=new i(e.orderCloseSize||"0"),a=new i(e.orderCloseValue||"0"),o=new i(e.feeRate||"0"),l=a.minus(t.times(n)),s=t.times(r).times(n.abs()),c=a.abs().times(o);return l.minus(s).plus(c).toFixed()}static getCreateOrderCost(e){var t,n,a,o,l;const s=new i(e.orderPrice),c=e.orderSide,u=new i(e.orderSize),d=St.getSymbolModel(e.contractId),m=r(),p=(null==(n=null==(t=m.position)?void 0:t.filter)?void 0:n.call(t,t=>t.contractId===e.contractId))||[];let g=p.length>0?new i(p[0].openSize):new i(0);const h={id:0,contractId:e.contractId,side:c,price:s.toFixed(),type:"LIMIT",createdTime:"0",triggerTime:"0",size:u.toFixed(),status:"OPEN",cumFailSize:"0",cumSize:"0",cumFee:"0",cumRealizedPnl:"0"};let v=null==(l=(null==(o=null==(a=m.order)?void 0:a.filter)?void 0:o.call(a,t=>t.contractId===e.contractId&&!t.isPositionTpsl))||[])?void 0:l.sort(wt);v=v.filter(e=>!("UNTRIGGERED"===e.status&&e.side!==c));for(let i=0;i<v.length;i++){const t=v[i];if(xt(h,t)>=0){const i=Rt({contractId:e.contractId,orderModel:t,positionOpenSize:g.toFixed()});g=g.plus((null==i?void 0:i.closeSize)||0).plus((null==i?void 0:i.openSize)||0)}}const f=Rt({contractId:e.contractId,orderModel:h,positionOpenSize:g.toFixed()}),w=St.getMaxTradeFeeRate(e.contractId),x=new i((null==d?void 0:d.oraclePrice)||0),I=St._getOpenOrderFrozenAmount({oraclePrice:x.toFixed(),initialMarginRate:St.getInitialMarginRateWithMaxLeverage(e.leverage||St.getOpenMaxLeverage((null==e?void 0:e.contractId)||"0")||"0"),orderOpenSize:f.openSize.toFixed(),orderOpenValue:f.openSize.times(s).toFixed(),feeRate:w.toFixed()}),R=St._getCloseOrderFrozenAmount({oraclePrice:x.toFixed(),initialMarginRate:St.getInitialMarginRateWithMaxLeverage(e.leverage||St.getOpenMaxLeverage((null==e?void 0:e.contractId)||"0")||"0"),orderCloseSize:f.closeSize.toFixed(),orderCloseValue:f.closeSize.times(s).toFixed(),feeRate:w.toFixed()});return i.max(new i(I).plus(new i(R)),0).decimalPlaces(4,i.ROUND_DOWN)}static getCollateralPendingWithdrawAmount(e){const t=r(),n=(null==t?void 0:t.withdraw)||[];let a=new i(0);return n.forEach(t=>{t.coinId===e&&(a=a.plus(new i(t.amount)))}),a}static getCollateralPendingTransferOutAmount(e){const t=r(),n=(null==t?void 0:t.transferOut)||[];let a=new i(0);return n.forEach(t=>{t.coinId!==e||"PENDING_CHECKING"!==t.status&&"PENDING_CENSORING"!==t.status||(a=i.max(a.plus(new i(t.amount)),0))}),a}static getCollateralTotalEquity(e){var t;const n=r(),a=(null==n?void 0:n.position)||[],o=null==(t=(null==n?void 0:n.collateral)||[])?void 0:t.find(t=>t.coinId===e);let l=new i((null==o?void 0:o.amount)||0);return a.forEach(t=>{let r=St.getSymbolModel(t.contractId);if((null==r?void 0:r.quoteCoinId)===e){let e=n.contractList.find(e=>e.contractId===t.contractId),r=new i((null==e?void 0:e.oraclePrice)||0),a=new i((null==t?void 0:t.openSize)||0).times(r||0);l=l.plus(a)}}),l}static getStarkExRiskValue(e){const t=r();St.getUserInfo();let n=new i(0);return((null==t?void 0:t.position)||[]).forEach(r=>{let a=St.getSymbolModel(r.contractId);if((null==a?void 0:a.quoteCoinId)===e){let e=t.contractList.find(e=>e.contractId===r.contractId),a=new i((null==e?void 0:e.oraclePrice)||0),o=new i((null==r?void 0:r.openSize)||0).times(a||0),l=St.getPositionStarkExRiskRate(r.contractId,o.toFixed());n=n.plus(St.getPositionStarkExRiskValue(o.toFixed(),l))}}),n}static getCollateralTotalEquityAfterFill(e){return new i((null==e?void 0:e.collateralTotalEquity)||0).minus((null==e?void 0:e.fillValue)||0).plus(new i(e.fillSize||"0").times((null==e?void 0:e.oraclePrice)||0)).plus((null==e?void 0:e.fillFee)||0)}static getCollateralStarkExRiskValueAfterFill(e){const t=(null==e?void 0:e.contractId)||"",r=new i((null==e?void 0:e.fillSize)||0),n=new i((null==e?void 0:e.oraclePrice)||0),a=new i((null==e?void 0:e.positionOpenSize)||0),o=a.times((null==e?void 0:e.oraclePrice)||0),l=St.getPositionRiskTier(o.toFixed(),t),s=null!==l?le.divide(l.starkExRisk,new i(2).pow(32)):new i(0),c=o.abs().times(s),u=a.plus(r).times(n),d=St.getPositionRiskTier(u.toFixed(),t),m=null!==d?le.divide(d.starkExRisk,new i(2).pow(32)):new i(0),p=u.abs().times(m);return new i((null==e?void 0:e.collateralStarkExRiskValue)||0).plus(p).minus(c)}static getCreateOrderLiquidatePrice(e){var t;const n=new i((null==e?void 0:e.orderSize)||0),a=null==e?void 0:e.orderSide,o=St.getSymbolModel(e.contractId),l=r(),s=St.getCollateralPendingWithdrawAmount((null==o?void 0:o.quoteCoinId)||""),c=St.getCollateralPendingTransferOutAmount((null==o?void 0:o.quoteCoinId)||""),u=St.getCollateralTotalEquity((null==o?void 0:o.quoteCoinId)||""),d=St.getStarkExRiskValue((null==o?void 0:o.quoteCoinId)||""),m=St.getMaxTradeFeeRate(e.contractId),p=l.position||[];let g=new i(0);for(let r=0;r<p.length;r++)p[r].contractId===e.contractId&&(g=g.plus(new i((null==(t=null==p?void 0:p[r])?void 0:t.openSize)||0)));const h=n.div("BUY"===a?1:-1),v=h.times((null==e?void 0:e.orderPrice)||0),f=v.times(m).abs().times(-1),w=new i((null==o?void 0:o.oraclePrice)||0),x=St.getCollateralTotalEquityAfterFill({oraclePrice:w.toFixed(),collateralTotalEquity:u.toFixed(),fillSize:h.toFixed(),fillValue:v.toFixed(),fillFee:f.toFixed()}),I=St.getCollateralStarkExRiskValueAfterFill({contractId:e.contractId,oraclePrice:w.toFixed(),positionOpenSize:g.toFixed(),collateralStarkExRiskValue:d.toFixed(),fillSize:h.toFixed()}),R=g.plus(h),S=St.getPositionLiquidatePrice({contractId:e.contractId,oraclePrice:w.toFixed(),positionOpenSize:R.toFixed(),collateralTotalEquity:x.toFixed(),collateralStarkExRiskValue:I.toFixed(),collateralPendingWithdrawAmount:s.toFixed(),collateralPendingTransferOutAmount:c.toFixed()});return i.max(S,new i(0))}static getInitialMarginRequirement(e){const t=r();let n=new i(0);const a=t.position||[];for(let r=0;r<a.length;r++){const o=a[r],l=St.getSymbolModel(o.contractId);if((null==l?void 0:l.quoteCoinId)===e){const e=t.contractList.find(e=>e.contractId===o.contractId),r=new i((null==e?void 0:e.oraclePrice)||0),a=new i((null==o?void 0:o.openSize)||0).times(r||0),l=St.getPositionMaxLeverage(o.contractId,a.toFixed()),s=St.getInitialMarginRateWithMaxLeverage(l||"0"),c=St.getPositionInitialMarginRequirement(a.toFixed(),s);n=n.plus(c)}}return n}static _getPositionWorstClosePrice(e){St.getSymbolModel(e.contractId);const t=new i(e.oraclePrice),r=new i(e.collateralTotalEquity).minus((null==e?void 0:e.collateralPendingWithdrawAmount)||0).minus((null==e?void 0:e.collateralPendingTransferOutAmount)||0),n=new i(e.positionOpenSize),a=new i(e.collateralStarkExRiskValue),o=St.getPositionStarkExRiskRate(e.contractId,e.positionOpenSize);if(n.lt(0)){let l=r.times(o).plus(a).times(t),s=a.times(new i(1).plus(new i(e.feeRate)));const c=vt(e.contractId),u=le.floor(l.div(s),c);let d=r.minus(a).plus(n.times(t).times(new i(-1)).times(new i(1).plus(o))),m=n.times(new i(-1)).times(new i(1).plus(new i(e.feeRate)));const p=le.floor(d.div(m),c);return i.max(u,p)}if(n.gt(0)){let l=a.minus(r.times(o)).times(t),s=a.times(new i(1).minus(new i(e.feeRate)));const c=vt(e.contractId),u=le.ceil(l.div(s),c);let d=r.minus(a).plus(n.times(t).times(new i(-1)).times(new i(1).minus(o))),m=n.times(new i(-1)).times(new i(1).minus(new i(e.feeRate)));const p=le.ceil(d.div(m),c);return i.min(u,p)}return new i(0)}static checkCloseOrderIsValid(e){let t=e.orderSide||"",r=St.getSymbolModel(e.contractId),n=St.getCoinModel((null==r?void 0:r.quoteCoinId)||""),a=new i((null==e?void 0:e.availableAmount)||"0"),o=ht((null==n?void 0:n.stepSize)||"0"),l=new i((null==e?void 0:e.positionOpenSize)||"0"),s=new i((null==e?void 0:e.orderCloseSizeAbs)||"0"),c=new i((null==e?void 0:e.orderCloseValueAbs)||"0"),u=(null==e?void 0:e.greaterOrderModelList)||[];if("BUY"===t){let t=St._getCloseOrderFrozenAmount({oraclePrice:e.oraclePrice,initialMarginRate:e.initialMarginRate,orderCloseSize:e.orderCloseSizeAbs,orderCloseValue:e.orderCloseValueAbs,feeRate:e.feeRate});a=a.minus(t),l=l.minus(s)}else{if("SELL"!==t)return!1;{let t=St._getCloseOrderFrozenAmount({oraclePrice:e.oraclePrice,initialMarginRate:e.initialMarginRate,orderCloseSize:s.negated().toFixed(),orderCloseValue:c.negated().toFixed(),feeRate:e.feeRate});a=a.minus(t),l=l.plus(s)}}for(let d=0;d<u.length;d++){const t=u[d];let r=new i(0);if("PENDING"===t.status||"OPEN"===t.status||"CANCELING"===t.status?r=t.isWithoutMatch?new i(t.withoutMatchFillSize).minus(new i(t.cumFailSize)).minus(new i(t.cumFillSize)):new i(t.size).minus(new i(t.cumFailSize)).minus(new i(t.cumFillSize)):"FILLED"===t.status&&(r=new i(t.cumMatchSize).minus(new i(t.cumFailSize)).minus(new i(t.cumFillSize))),r.lte(0))continue;let n=new i(0);t.isWithoutMatch?(n=r.times(new i(t.withoutMatchFillValue)).div(t.withoutMatchFillSize),n="BUY"===t.side?n.decimalPlaces(Number(o),i.ROUND_CEIL):n.decimalPlaces(Number(o),i.ROUND_FLOOR)):new i(t.price).isZero()?(n=r.times(new i(t.marketLimitValue||"0")).div(t.size),n="BUY"===t.side?n.decimalPlaces(Number(o),i.ROUND_CEIL):n.decimalPlaces(Number(o),i.ROUND_FLOOR)):n=r.times(t.price||0);let s=new i(0);"BUY"===t.side&&l.lt(0)?s=i.min(r,l.negated()):"SELL"===t.side&&l.gt(0)&&(s=i.max(r.negated(),l.negated()));let c=new i(0);c="BUY"===t.side?r.minus(s):r.negated().minus(s);let m=s.times(n||0).div(r);m=m.decimalPlaces(Number(o),i.ROUND_FLOOR);let p=new i(0);p="BUY"===t.side?n.minus(m):n.negated().minus(m);let g=St._getCloseOrderFrozenAmount({oraclePrice:e.oraclePrice,initialMarginRate:e.initialMarginRate,orderCloseSize:s.toFixed(),orderCloseValue:m.toFixed(),feeRate:e.feeRate}),h=St._getOpenOrderFrozenAmount({oraclePrice:e.oraclePrice,initialMarginRate:e.initialMarginRate,orderOpenSize:c.toFixed(),orderOpenValue:p.toFixed(),feeRate:e.feeRate});if(a=a.plus(g).plus(h),!c.isZero()&&a.lt(0))return!1;l="BUY"===t.side?l.plus(r):l.minus(r)}return!0}static getRiskTierModel(e,t){if(!t.length)return null;const r=[...t].sort((e,t)=>new i(t.positionValueUpperBound||0).comparedTo(e.positionValueUpperBound||0));for(const n of r)if(new i(e).lte(n.maxLeverage))return n;return r[0]}static getRiskLimitTierMaxOpenQuantityWithLever(e){var t,n;St.getUserInfo();const a=St.getSymbolModel(e.contractId),o=new i((null==a?void 0:a.oraclePrice)||0).times(1.001);if(o.isZero())return new i(0);const l=(null==a?void 0:a.riskTierList)||[],s=St.getRiskTierModel(e.inputLever,l),c=new i((null==s?void 0:s.positionValueUpperBound)||0),u=null==(n=null==(t=r().position)?void 0:t.find)?void 0:n.call(t,t=>t.contractId===e.contractId),d=new i((null==u?void 0:u.openSize)||"0");let m=new i(0);return m="BUY"===e.orderSide?c.div(o).minus(d):c.div(o).plus(d),i.max(m,new i(0))}static getMaxCreateOrderSize(e){var t,n,a,o,l,s,c,u,d,m,p,g,h,v;const f=r(),w=St.getSymbolModel(e.contractId),x=(null==w?void 0:w.quoteCoinId)||"",I=e.orderSide,R=new i(e.orderPrice||0),S=e.reduceOnly,P=St.getCollateralPendingWithdrawAmount(x||""),F=St.getCollateralPendingTransferOutAmount(x||""),k=St.getCollateralTotalEquity(x||""),y=St.getInitialMarginRequirement(x||""),b=St.getStarkExRiskValue(x||"");let T=k.minus(P).minus(F).minus(y),L=null,O="",E=new i(0),N=new i(0),z=null==(o=null==(a=(null==(n=null==(t=f.order)?void 0:t.filter)?void 0:n.call(t,t=>t.contractId===e.contractId))||[])?void 0:a.sort)?void 0:o.call(a,wt);for(let r=0;r<z.length;r++){let t=z[r];if(t.contractId===e.contractId&&t.side===e.orderSide)continue;if(t.contractId!==(null!==L?null==L?void 0:L.contractId:null)||t.side!==O){T=T.minus(i.max(N,new i(0))),L=St.getSymbolModel(t.contractId),O=t.side;let e=(null==(s=null==(l=f.position)?void 0:l.filter)?void 0:s.call(l,e=>e.contractId===t.contractId))||[];e.length>0&&(E=new i((null==(c=null==e?void 0:e[0])?void 0:c.openSize)||0)),N=new i(0)}const n=t.contractId,a=St.getOpenMaxLeverage(t.contractId);let o=St.getInitialMarginRateWithMaxLeverage(a||"0"),u=St.getMaxTradeFeeRate(t.contractId),d=Rt({contractId:n,orderModel:t,positionOpenSize:E.toFixed()}),m=(null==L?void 0:L.oraclePrice)||"0",p=St._getCloseOrderFrozenAmount({oraclePrice:m,initialMarginRate:o,orderCloseSize:d.closeSize.toFixed(),orderCloseValue:d.closeValue.toFixed(),feeRate:u.toFixed()}),g=St._getOpenOrderFrozenAmount({oraclePrice:m,initialMarginRate:o,orderOpenSize:d.openSize.toFixed(),orderOpenValue:d.openValue.toFixed(),feeRate:u.toFixed()});N=N.plus(p).plus(g),E=E.minus(d.closeSize).minus(d.openSize)}T=T.minus(i.max(N,new i(0)));let M=(null==(u=St.getSymbolModel(e.contractId))?void 0:u.oraclePrice)||"0",C=St.getMaxTradeFeeRate(e.contractId),A=St.getOpenMaxLeverage(e.contractId),_=St.getInitialMarginRateWithMaxLeverage(A||"0"),B=(null==(m=null==(d=f.position)?void 0:d.filter)?void 0:m.call(d,t=>t.contractId===e.contractId))||[],D=B.length>0?new i((null==(p=B[0])?void 0:p.openSize)||"0"):new i(0),U=St._getPositionWorstClosePrice({contractId:e.contractId,oraclePrice:M,positionOpenSize:D.toFixed(),collateralTotalEquity:k.toFixed(),collateralStarkExRiskValue:b.toFixed(),collateralPendingWithdrawAmount:P.toFixed(),collateralPendingTransferOutAmount:F.toFixed(),feeRate:C.toFixed()});const V={id:0,contractId:e.contractId,side:I,price:R.toFixed(),type:"LIMIT",createdTime:"0",triggerTime:"0"};let q=[];for(let r=0;r<z.length;r++){const t=z[r];if(t.contractId!==V.contractId&&t.side!==e.orderSide)continue;if(xt(V,t)<0){q.push(t);continue}if(t.contractId!==e.contractId||t.side!==e.orderSide){let e=(null==(h=null==(g=f.position)?void 0:g.filter)?void 0:h.call(g,e=>e.contractId===t.contractId))||[];e.length>0&&(E=new i((null==(v=null==e?void 0:e[0])?void 0:v.openSize)||0))}const n=St.getOpenMaxLeverage(t.contractId)||"0";let a=St.getInitialMarginRateWithMaxLeverage(n),o=St.getMaxTradeFeeRate(t.contractId),l=Rt({contractId:t.contractId,orderModel:t,positionOpenSize:E.toFixed()}),s=St._getCloseOrderFrozenAmount({oraclePrice:M,initialMarginRate:a,orderCloseSize:l.closeSize.toFixed(),orderCloseValue:l.closeValue.toFixed(),feeRate:o.toFixed()}),c=St._getOpenOrderFrozenAmount({oraclePrice:M,initialMarginRate:a,orderOpenSize:l.openSize.toFixed(),orderOpenValue:l.openValue.toFixed(),feeRate:o.toFixed()});T=T.minus(s).minus(c),D=D.minus(l.closeSize).minus(l.openSize)}let K=new i(0);if(("BUY"===I&&D.lt(0)||"SELL"===I&&D.gt(0))&&(K=D.abs()),K.gt(0)){if("BUY"===I&&R.gt(U)||"SELL"===I&&R.lt(U))return new i(0);if(!St.checkCloseOrderIsValid({contractId:e.contractId,oraclePrice:M,initialMarginRate:_,positionOpenSize:D.toFixed(),availableAmount:T.toFixed(),greaterOrderModelList:q,orderSide:I,orderCloseSizeAbs:K.toFixed(),orderCloseValueAbs:R.times(K).toFixed(),feeRate:C.toFixed()})){let t=new i(0),r=K,n=ft(e.contractId);for(;r.minus(t).gt((null==w?void 0:w.stepSize)||0);){let a=r.plus(t).div(2).decimalPlaces(n||0,i.ROUND_FLOOR);St.checkCloseOrderIsValid({contractId:e.contractId,oraclePrice:M,initialMarginRate:_,positionOpenSize:D.toFixed(),availableAmount:T.toFixed(),greaterOrderModelList:q,orderSide:I,orderCloseSizeAbs:a.toFixed(),orderCloseValueAbs:R.times(a).toFixed(),feeRate:C.toFixed()})?t=a:r=a}return t}if("BUY"===I){let e=St._getCloseOrderFrozenAmount({oraclePrice:M,initialMarginRate:_,orderCloseSize:K.toFixed(),orderCloseValue:R.times(K).toFixed(),feeRate:C.toFixed()});T=T.minus(e)}else if("SELL"===I){let e=St._getCloseOrderFrozenAmount({oraclePrice:M,initialMarginRate:_,orderCloseSize:K.negated().toFixed(),orderCloseValue:R.times(K).negated().toFixed(),feeRate:C.toFixed()});T=T.minus(e)}}if(S)return K;for(let i of q){let t=Rt({contractId:e.contractId,orderModel:i,positionOpenSize:D.toFixed()}),r=St._getOpenOrderFrozenAmount({oraclePrice:M,initialMarginRate:_,orderOpenSize:t.openSize.toFixed(),orderOpenValue:t.openValue.toFixed(),feeRate:C.toFixed()});T=T.minus(r)}let G=new i(0);G="BUY"===I?i.max(R.minus(M),new i(0)).plus(new i(M).times(_)).plus(R.times(C)):"SELL"===I?i.max(new i(M).minus(R),new i(0)).plus(new i(M).times(_)).plus(R.times(C)):new i(0);let W=new i(0);if(G.lte(new i(0)))W=new i(0);else{const t=ft(e.contractId);W=t<0?i.max(T.div(G).times(10**t).dp(0,i.ROUND_FLOOR).div(10**t),new i(0)):i.max(T.div(G).decimalPlaces(ft(e.contractId),i.ROUND_FLOOR),new i(0))}let $=K.plus(W),Y=St.getOpenMaxLeverage(e.contractId)||"0",j=St.getRiskLimitTierMaxOpenQuantityWithLever({contractId:e.contractId,orderSide:I,inputLever:Y});return i.min(j,$)}static getItemOrderFrozenAmount(e){var t,n;const a=e.orderSide;if("UNKNOWN_ORDER_SIDE"===a||"UNRECOGNIZED"===a)return new i(0);const o=r();St.getUserInfo();const l=o.position||[];let s=0===l.length?new i(0):new i(l[0].openSize),c=new i(0);const u=null==(n=null==(t=o.order||[])?void 0:t.sort)?void 0:n.call(t,wt);for(let i of u)if(i.contractId===e.contractId&&i.side===a){const t=St.getOpenMaxLeverage(e.contractId)||"0";let r=St.getInitialMarginRateWithMaxLeverage(t),n=St.getMaxTradeFeeRate(e.contractId),a=Rt({contractId:e.contractId,orderModel:i,positionOpenSize:s.toFixed()}),o=St._getCloseOrderFrozenAmount({oraclePrice:e.oraclePrice,initialMarginRate:r,orderCloseSize:a.closeSize.toFixed(),orderCloseValue:a.closeValue.toFixed(),feeRate:n.toFixed()}),l=St._getOpenOrderFrozenAmount({oraclePrice:e.oraclePrice,initialMarginRate:r,orderOpenSize:a.openSize.toFixed(),orderOpenValue:a.openValue.toFixed(),feeRate:n.toFixed()});c=c.plus(o).plus(l),s=s.plus(a.closeSize).plus(a.openSize)}return i.max(c,new i(0))}static getCollateralAvailableAmount(e,t){var n,a,o;const l=r(),s=t||(null==l?void 0:l.position)||[],c=null==(n=(null==l?void 0:l.collateral)||[])?void 0:n.find(t=>t.coinId===e);let u=new i((null==c?void 0:c.amount)||0),d=St.getCollateralPendingWithdrawAmount(e),m=St.getCollateralPendingTransferOutAmount(e),p=new i(0);s.forEach(t=>{let r=St.getSymbolModel(t.contractId);if((null==r?void 0:r.quoteCoinId)===e){let e=new i((null==r?void 0:r.oraclePrice)||0),n=new i((null==t?void 0:t.openSize)||0).times(e||0),a=St.getPositionMaxLeverage(t.contractId,n.toFixed()),o=St.getInitialMarginRateWithMaxLeverage(a||"0"),l=St.getPositionInitialMarginRequirement(n.toFixed(),o);u=u.plus(n),p=p.plus(l)}});let g=new i(0);new Set((null==(o=null==(a=null==l?void 0:l.order)?void 0:a.map)?void 0:o.call(a,e=>e.contractId))||[]).forEach(t=>{let r=St.getSymbolModel(t);if((null==r?void 0:r.quoteCoinId)===e){let e=new i((null==r?void 0:r.oraclePrice)||0),n=St.getItemOrderFrozenAmount({contractId:t,oraclePrice:e.toFixed(),orderSide:"BUY"}),a=St.getItemOrderFrozenAmount({contractId:t,oraclePrice:e.toFixed(),orderSide:"SELL"});g=g.plus(n).plus(a)}});const h=u.minus(p).minus(d).minus(m).minus(g);return i.max(h,new i(0))}static calculateAvailableBalance(e){let t=St.getSymbolModel(e);const i=(null==t?void 0:t.quoteCoinId)||"";return St.getCollateralAvailableAmount(i).toFixed()}}const Pt={class:"text-14px color-[--main-text] lh-20px"},Ft=["innerHTML"],kt={class:"bg-[--border] p-16px mt-16px"},yt={class:"flex items-center"},bt={class:"flex-1"},Tt={class:"flex items-center mt-16px"},Lt={class:"flex-1"},Ot={class:"flex items-center mt-16px"},Et={class:"flex-1"},Nt={class:"flex items-center mt-16px"},zt={class:"flex-1"},Mt={class:"text-14px color-[--main-text] lh-20px"},Ct={class:"bg-[--border] p-16px mt-16px"},At={class:"flex"},_t={key:0,class:"relative flex items-center justify-center mr-8px w-20px h-20px text-14px"},Bt={class:"flex-1"},Dt={class:"text-16px font-500 mb-5px"},Ut={class:"text-14px font-400 color-[--secondary-text]"},Vt={class:"flex mt-24px"},qt={key:0,class:"relative flex items-center justify-center mr-8px w-20px h-20px text-14px"},Kt={class:"flex-1"},Gt={class:"text-16px font-500 mb-5px"},Wt={class:"text-14px font-400 color-[--secondary-text]"},$t=n({__name:"index",props:{getVisible:{type:Function,default:()=>o(!1)}},emits:["success"],setup(e,{emit:t}){const i=e,n=t,F=o(1),k=r();function y(){return k.login().then(()=>{n("success")}).catch(e=>{})}function b(){k.apiKeys&&!k.l2KeyPair?F.value=2:F.value=1}return a(()=>i.getVisible().value,e=>{e&&b()}),l(()=>{b()}),(e,t)=>{const i=h,r=I;return c(),s(P,null,[u(p("div",Pt,[p("div",{innerHTML:e.$t("perpAgreementTitle")},null,8,Ft),p("ul",kt,[p("li",yt,[g(i,{name:"bi:check-circle-fill",class:"text-16px mr-8px"}),p("span",bt,v(e.$t("perpAgreement1")),1)]),p("li",Tt,[g(i,{name:"bi:check-circle-fill",class:"text-16px mr-8px"}),p("span",Lt,v(e.$t("perpAgreement2")),1)]),p("li",Ot,[g(i,{name:"bi:check-circle-fill",class:"text-16px mr-8px"}),p("span",Et,v(e.$t("perpAgreement3")),1)]),p("li",Nt,[g(i,{name:"bi:check-circle-fill",class:"text-16px mr-8px"}),p("span",zt,v(e.$t("perpAgreement4")),1)])]),g(r,{type:"primary",size:"large",class:"w-100% min-h-48px mt-20px",onClick:t[0]||(t[0]=x(e=>F.value=2,["stop"]))},{default:f(()=>[w(v(e.$t("agreeAndContinue")),1)]),_:1})],512),[[d,1===m(F)]]),u(p("div",Mt,[p("div",null,v(e.$t("perpSignTips")),1),p("ul",Ct,[p("li",At,[m(k).apiKeys?(c(),R(i,{key:1,name:"bi:check-circle-fill",class:"text-22px mr-8px color-[--up-color]"})):(c(),s("div",_t,[t[1]||(t[1]=p("span",{class:"relative z-2 w-20px h-20px rd-50% bg-[--icon-color] text-center lh-19px"},"1",-1)),m(k).apiSignatureLoading?(c(),R(i,{key:0,name:"line-md:loading-loop",class:"text-26px absolute left-50% top-50% -translate-50% z-1 color-[--up-color]"})):S("",!0)])),p("div",Bt,[p("div",Dt,v(e.$t("verifyOwnership")),1),p("div",Ut,v(e.$t("verifyOwnershipDesc")),1)])]),p("li",Vt,[m(k).l2KeyPair?(c(),R(i,{key:1,name:"bi:check-circle-fill",class:"text-22px mr-8px color-[--up-color]"})):(c(),s("div",qt,[t[2]||(t[2]=p("span",{class:"relative z-2 w-20px h-20px rd-50% bg-[--icon-color] text-center lh-19px"},"2",-1)),m(k).starkSignatureLoading?(c(),R(i,{key:0,name:"line-md:loading-loop",class:"text-26px absolute left-50% top-50% -translate-50% z-1 color-[--up-color]"})):S("",!0)])),p("div",Kt,[p("div",Gt,v(e.$t("enableTrading")),1),p("div",Wt,v(e.$t("enableTradingDesc")),1)])])]),g(r,{type:"primary",size:"large",class:"w-100% min-h-48px mt-20px",loading:m(k).starkSignatureLoading||m(k).apiSignatureLoading,onClick:x(y,["stop"])},{default:f(()=>[w(v(e.$t("continue")),1)]),_:1},8,["loading"])],512),[[d,2===m(F)]])],64)}}}),Yt=["function allowance(address owner, address spender) view returns (uint256)","function approve(address spender, uint256 value) returns (bool)","function deposit(address token, uint256 amount, uint256 starkKey, uint256 positionId, bytes exchangeData) payable returns (uint256)","function withdraw(uint256 ownerKey, uint256 assetType)"],jt=async e=>{var t,i,n,a,o,l;const s=F().chain,c=k(s).chain_id,u=null==(l=null==(o=null==(a=null==(n=null==(i=null==(t=r().metadata)?void 0:t.multiChain)?void 0:i.chainList)?void 0:n.find(e=>e.chainId===c))?void 0:a.tokenList)?void 0:o.find)?void 0:l.call(o,t=>t.tokenAddress===e),d=await y(),m=new b(e,Yt,d),p=(null==u?void 0:u.contractAddress)||"",g=O;return m.approve.estimateGas(p,g).then(e=>m.approve(p,g,{gasLimit:(2n*e).toString()})).catch(e=>{if("CALL_EXCEPTION"!==(null==e?void 0:e.code)&&"execution reverted"!==(null==e?void 0:e.message))throw e;return m.approve(p,"0").then(e=>e.wait()).then(async()=>{const e=await m.approve.estimateGas(p,O);return m.approve(p,O,{gasLimit:(2n*e).toString()})})})},Zt=async()=>{var e,t,i,n,a,o,l,s,c,u,d,m,p;const g=F(),h=g.chain;if("eth"!==h)return Promise.reject("è¯·æŠŠé’±åŒ…åˆ‡æ¢åˆ° eth é“¾å†æå–");const v=k(h).chain_id,f=r(),w=(null==(o=null==(a=null==(n=null==(i=null==(t=null==(e=f.metadata)?void 0:e.multiChain)?void 0:t.chainList)?void 0:i.find(e=>Number(e.chainId)===Number(v)))?void 0:n.tokenList)?void 0:a.find)||o.call(a,e=>"0xdAC17F958D2ee523a2206206994597C13D831ec7"===e.tokenAddress),await y()),x=new b((null==(s=null==(l=null==f?void 0:f.metadata)?void 0:l.global)?void 0:s.starkExContractAddress)||"",Yt,w),I=(null==(c=f.userInfo)?void 0:c.ethAddress)||g.address||"",R=(null==(u=f.metadata)?void 0:u.multiChain.coinId)||"1000",S=(null==(p=null==(m=null==(d=f.metadata)?void 0:d.coinList)?void 0:m.find(e=>e.coinId===R))?void 0:p.starkExAssetId)||"0x0";return x.withdraw.estimateGas(I,S).then(e=>x.withdraw(I,S,{gasLimit:(2n*e).toString()}))},Ht=async e=>1===Number(e.chain)?async function(e){var t;const i=r(),n=F(),a=(null==(t=i.userInfo)?void 0:t.id)||"",o=i.metadata,l=(null==o?void 0:o.multiChain.coinId)||"1000",s={accountId:a,coinId:l,amount:e,ethAddress:E(n.address),clientWithdrawId:Date.now().toString(),expireTime:(Date.now()+12096e5).toString()},c=i.getSdk(),{params:u,headers:d}=await c.generateETHWithdrawParams(s,1);return T("/api/v1/private/assets/createNormalWithdraw",{headers:d,method:"POST",body:u})}(e.amount):async function(e){var t;const n=r(),a=F(),o=(null==(t=n.userInfo)?void 0:t.id)||"",{tokenAddress:l,amount:s,chain:c}=e,{crossWithdrawL2Key:u,crossWithdrawMaxAmount:d,fee:m,lpAccountId:p}=await Xt(e);if(new i(s).gt(d))throw new Error("è¶…å‡ºæœ€å¤§æçŽ°é¢åº¦");const g={accountId:o,coinId:"1000",amount:new i(s).minus(new i(m)).toFixed(),ethAddress:E(a.address),erc20Address:E(l),lpAccountId:p,clientCrossWithdrawId:Date.now().toString(),expireTime:String(36e5*Math.ceil((new Date).getTime()/36e5)+12096e5),fee:m,chainId:Number(c),crossWithdrawL2Key:u},h=g.chainId,v=n.getSdk(),{params:f,headers:w}=await v.generateCrossWithdrawParams(g,h);return T("/api/v1/private/assets/createCrossWithdraw",{method:"POST",body:f})}(e);async function Xt(e){const{tokenAddress:t,amount:i,chain:r}=e;return T("/api/v1/private/assets/getCrossWithdrawSignInfo",{method:"get",query:{chainId:r,amount:i,tokenAddress:t}})}async function Jt(e){var t;const i=r(),n=(null==e?void 0:e.accountId)||(null==(t=i.userInfo)?void 0:t.id)||"",a=(null==e?void 0:e.contractId)||"",o=e.type,l={...e,price:(null==o?void 0:o.includes("LIMIT"))?e.price.toString():"0",size:(null==e?void 0:e.size)||"1",type:o,timeInForce:"LIMIT"===o?"GOOD_TIL_CANCEL":"IMMEDIATE_OR_CANCEL",contractId:a,side:null==e?void 0:e.side,triggerPrice:(null==e?void 0:e.triggerPrice)||"",triggerPriceType:(null==e?void 0:e.triggerPriceType)||"LAST_PRICE",extraType:(null==e?void 0:e.extraType)||"",extraDataJson:(null==e?void 0:e.extraDataJson)||"",accountId:n},s=(i.contractList||[]).find(e=>e.contractId===a),{takerFeeRate:c,makerFeeRate:u}=nt(a),d={contractId:(null==e?void 0:e.contractId)||"",symbol:(null==s?void 0:s.contractName)||"",contractName:(null==s?void 0:s.contractName)||"",oraclePrice:(null==s?void 0:s.oraclePrice)||"0",tickSize:(null==s?void 0:s.tickSize)||"0.0001",takerFeeRate:c,makerFeeRate:u},m={accountId:n},p=i.getSdk(),{headers:g,params:h}=await p.generateTradeParams({tradeParams:l,symbolInfo:d,chainInfo:{chainId:"1"},accountInfo:m,requestPath:"/api/v1/private/order/createOrder",requestMethod:"POST"});return T("/api/v1/private/order/createOrder",{headers:g,method:"POST",body:h})}const Qt={class:"perp-deposit"},ei={class:"flex items-center color-[--yellow] text-12px mb-15px"},ti={class:"flex-1"},ii={class:"color-[--third-text]"},ri={class:"inline-flex items-center vertical-middle"},ni=["src"],ai=["src"],oi={class:"color-[--third-text]"},li={class:"inline-flex items-center vertical-middle"},si=["src"],ci=["src"],ui={class:"color-[--third-text]"},di={class:"text-12px color-[--third-text] mt-8px text-right"},mi={key:0},pi={key:0,class:"flex flex-col items-center justify-center text-center mt-20px"},gi={class:"text-14px color-[--main-text]"},hi={class:"text-12px color-[--secondary-text] mt-5px"},vi={class:"text-14px flex items-center justify-between mt-32px rd-4px"},fi={class:"color-[--secondary-text]"},wi={class:"color-[--main-text]"},xi={class:"text-14px flex items-center justify-between mt-16px rd-4px"},Ii={class:"color-[--secondary-text]"},Ri={class:"color-[--main-text] ml-auto"},Si={key:0,class:"color-[--main-text] ml-5px"},Pi={class:"ml-3px"},Fi={key:2,disabled:"",class:"w-full text-16px h-48px bg-[--border] color-[--secondary-text] flex items-center justify-center border-none rd-8px mt-20px cursor-not-allowed"},ki=$(n({__name:"deposit",props:{getVisible:{type:Function,default:()=>o(!1)}},emits:["success"],setup(e,{emit:t}){const n=e,u=t,d=F(),{t:T}=N(),O=z({chain:"56",token:"USDT",amount:""}),E=o({}),$=M(()=>{var e;return(null==(e=E.value)?void 0:e[O.token+"-"+O.chain])||0}),{prepBalance:Y}=Sr(),j=async()=>{var e,t,i,r,n;if(!O.token||!O.chain)return;const a=null==(n=null==(r=null==(i=null==(t=null==(e=Q.metadata)?void 0:e.multiChain)?void 0:t.chainList)?void 0:i.find(e=>e.chainId===O.chain))?void 0:r.tokenList)?void 0:n.find(e=>e.token===O.token);return a?D(a.tokenAddress).then(e=>{const t=(null==a?void 0:a.decimals)||0,i=U(e,Number(t));return E.value[O.token+"-"+O.chain]=i,i}):void 0},Z=o({}),H=M(()=>{var e;const t=(null==(e=Z.value)?void 0:e[O.token+"-"+O.chain])||0;return new i(t).gte(O.amount||0)});function X(){var e,t,i,r,n;return null==(n=null==(r=null==(i=null==(t=null==(e=Q.metadata)?void 0:e.multiChain)?void 0:t.chainList)?void 0:i.find(e=>e.chainId===O.chain))?void 0:r.tokenList)?void 0:n.find(e=>e.token===O.token)}function J(){var e,t,i,n,a;if(!O.token||!O.chain)return;const o=null==(a=null==(n=null==(i=null==(t=null==(e=Q.metadata)?void 0:e.multiChain)?void 0:t.chainList)?void 0:i.find(e=>e.chainId===O.chain))?void 0:n.tokenList)?void 0:a.find(e=>e.token===O.token);return o?(e=>{var t,i,n,a,o,l;const s=F(),c=s.chain,u=k(c).chain_id,d=null==(l=null==(o=null==(a=null==(n=null==(i=null==(t=r().metadata)?void 0:t.multiChain)?void 0:i.chainList)?void 0:n.find(e=>e.chainId===u))?void 0:a.tokenList)?void 0:o.find)?void 0:l.call(o,t=>t.tokenAddress===e),{_provider:m}=L(c);return new b(e,Yt,m).allowance(s.address,(null==d?void 0:d.contractAddress)||"")})(o.tokenAddress).then(e=>{const t=(null==o?void 0:o.decimals)||0,i=U(e,Number(t));return Z.value[O.token+"-"+O.chain]=i,i}):void 0}const Q=r(),ee=[{token:"USDT",iconUrl:"https://static.edgex.exchange/icons/coin/USDT.svg"},{token:"USDC",iconUrl:"https://static.edgex.exchange/icons/coin/USDC.svg"}],te=M(()=>{var e,t;return null==(t=(null==(e=Q.metadata)?void 0:e.multiChain.chainList)||[])?void 0:t.filter(e=>{var t;return null==(t=e.tokenList)?void 0:t.some(e=>e.token===O.token)})}),ie=M(()=>{var e,t;return(null==(e=te.value.find(e=>e.chainId===O.chain))?void 0:e.chain)||(null==(t=k(O.chain||"",!0))?void 0:t.name)||""});a(()=>O.chain,e=>{e&&(O.amount="")}),a(te,e=>{if(e.length){if(null==e?void 0:e.some(e=>e.chainId===O.chain))return;O.chain=e[0].chainId}});const re=M(()=>{var e,t,i,r;return O.chain&&O.token&&O.amount&&(null==(r=null==(i=(null==(t=null==(e=Q.metadata)?void 0:e.multiChain)?void 0:t.chainList)||[])?void 0:i.some)?void 0:r.call(i,e=>e.chainId===O.chain))});function ne(){var e,t,i;const r=(null==(e=Q.metadata)?void 0:e.multiChain.chainList)||[],n=(null==(t=k(d.chain))?void 0:t.chain_id)||(null==(i=null==r?void 0:r[0])?void 0:i.chainId);O.token="USDT",(null==r?void 0:r.some(e=>e.chainId===n))?(O.chain=n,j()):O.chain=void 0,J()}a(()=>O.token,()=>{j(),J()}),a(()=>n.getVisible().value,e=>{e&&ne()}),a(()=>O.chain,e=>{var t;if(e){const i=null==(t=k(e,!0))?void 0:t.net_name;if(i===d.chain)return;C(i||"",d.provider,[d.address]).then(e=>{j(),J()})}});const le=o(!1);async function se(){const e=X();le.value=!0;const t=V({icon:q("div",{class:"el-loading-spinner",style:"--el-loading-spinner-size: 24px"},[q("svg",{viewBox:"0 0 50 50",class:"circular"},[q("circle",{class:"path",style:"stroke-width: 3",cx:"25",cy:"25",r:"20",fill:"none"})])]),message:T("approving")+"...",duration:0});jt((null==e?void 0:e.tokenAddress)||"").then(e=>e.wait()).then(async e=>{var i;return null==(i=null==t?void 0:t.close)||i.call(t),V({type:"success",message:T("approveSuccess")}),J(),e}).catch(e=>{var i;null==(i=null==t?void 0:t.close)||i.call(t),le.value=!1,K(e)})}const ce=o(!1);async function ue(){var e,t;if(!re.value)return;const n=(null==(t=null==(e=Q.metadata)?void 0:e.multiChain)?void 0:t.minDeposit)||0;if(new i(O.amount||0).lt(n))return void G.error(T("minDeposit",{amount:n}));ce.value=!0;const a=await async function(){var e;await J();const t=(null==(e=Z.value)?void 0:e[O.token+"-"+O.chain])||0;return new i(t).gte(O.amount||0)}(),o=X();if(!a){const e=V({icon:q("div",{class:"el-loading-spinner",style:"--el-loading-spinner-size: 24px"},[q("svg",{viewBox:"0 0 50 50",class:"circular"},[q("circle",{class:"path",style:"stroke-width: 3",cx:"25",cy:"25",r:"20",fill:"none"})])]),message:T("approving")+"...",duration:0});await jt((null==o?void 0:o.tokenAddress)||"").then(e=>e.wait()).then(async t=>{var i;return null==(i=null==e?void 0:e.close)||i.call(e),V({type:"success",message:T("approveSuccess")}),t}).catch(t=>{var i;return null==(i=null==e?void 0:e.close)||i.call(e),ce.value=!1,K(t),Promise.reject(t)})}const l=W(O.amount||0,(null==o?void 0:o.decimals)||0).toFixed(0);(async(e,t)=>{var i,n,a,o,l,s,c,u;const d=F().chain,m=k(d).chain_id,p=r(),g=null==(s=null==(l=null==(o=null==(a=null==(n=null==(i=p.metadata)?void 0:i.multiChain)?void 0:n.chainList)?void 0:a.find(e=>e.chainId===m))?void 0:o.tokenList)?void 0:l.find)?void 0:s.call(l,t=>t.tokenAddress===e),h=await y(),v="0x"+(null==(c=p.l2KeyPair)?void 0:c.l2PublicKey),f=null==(u=p.userInfo)?void 0:u.id,w=new b((null==g?void 0:g.contractAddress)||"",Yt,h);return w.deposit.estimateGas(e,t,v,f,"0x").then(i=>w.deposit(e,t,v,f,"0x",{gasLimit:(2n*i).toString()}))})((null==o?void 0:o.tokenAddress)||"",l).then(e=>(V({type:"success",message:T("depositTxSubmitted")}),e.wait())).then(e=>{V({type:"success",message:T("depositComplete")}),u("success",e),ce.value=!1}).catch(e=>{ce.value=!1,K(e)})}return l(()=>{ne()}),(e,t)=>{var r,n,a;const o=h,l=ae,u=oe,d=_,F=I;return c(),s("div",Qt,[p("div",ei,[g(o,{name:"carbon:warning-filled",class:"text-14px color-[--yellow] mr-3px mb--1px"}),p("span",ti,v(e.$t("perpDepositTips")),1)]),g(u,{modelValue:m(O).token,"onUpdate:modelValue":t[0]||(t[0]=e=>m(O).token=e),placeholder:"Select",class:"mb-16px",size:"large",persistent:!1},{prefix:f(()=>[p("div",ii,v(e.$t("token")),1)]),label:f(({value:e,label:t})=>{var i,r;return[p("div",ri,[p("img",{src:null==(r=null==(i=null==ee?void 0:ee.find)?void 0:i.call(ee,t=>t.token===e))?void 0:r.iconUrl,class:"rd-50% mr-5px",width:"24",lazy:"",alt:""},null,8,ni),p("span",null,v(t||""),1)])]}),default:f(()=>[(c(),s(P,null,A(ee,e=>g(l,{key:e.token,label:e.token,value:e.token,class:"h-40px! flex items-center"},{default:f(()=>[p("img",{src:e.iconUrl,class:"rd-50% mr-5px",width:"24",lazy:"",alt:""},null,8,ai),p("span",null,v(e.token||""),1)]),_:2},1032,["label","value"])),64))]),_:1},8,["modelValue"]),g(u,{modelValue:m(O).chain,"onUpdate:modelValue":t[1]||(t[1]=e=>m(O).chain=e),class:"mb-16px",placeholder:"Select",style:{width:"100%"},size:"large",persistent:!1},{prefix:f(()=>[p("div",oi,v(e.$t("chain1")),1)]),label:f(({value:t,label:i})=>{var r,n,a;return[p("div",li,[p("img",{src:null==(r=m(te).find(e=>e.chainId===t))?void 0:r.chainIconUrl,class:"rd-50% mr-5px",width:"24",lazy:"",alt:""},null,8,si),p("span",null,v((null==(n=m(te).find(e=>e.chainId===t))?void 0:n.chain)||(null==(a=("getChainInfo"in e?e.getChainInfo:m(k))(t,!0))?void 0:a.name)||i||""),1)])]}),default:f(()=>[(c(!0),s(P,null,A(m(te),e=>(c(),R(l,{key:e.chainId,label:e.chain,value:e.chainId,class:"h-40px! flex items-center"},{default:f(()=>[p("img",{src:e.chainIconUrl,class:"rd-50% mr-5px",width:"24",lazy:"",alt:""},null,8,ci),p("span",null,v(e.chain||""),1)]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue"]),g(d,{modelValue:m(O).amount,"onUpdate:modelValue":t[3]||(t[3]=e=>m(O).amount=e),class:"text-right",inputmode:"decimal",clearable:"",placeholder:"0.00",size:"large",onInput:t[4]||(t[4]=e=>m(O).amount=e.replace(/\-|[^\d.]/g,""))},{prefix:f(()=>[p("div",ui,v(e.$t("amount")),1)]),suffix:f(()=>[p("button",{class:"color-[--primary-color] border-none bg-transparent clickable text-14px",onClick:t[2]||(t[2]=x(e=>m(O).amount=m($),["stop"]))},v(e.$t("max")),1)]),_:1},8,["modelValue"]),p("div",di,[p("span",null,v(e.$t("available"))+": ",1),p("span",null,v(("formatNumber"in e?e.formatNumber:m(B))(m($),3))+" "+v((null==(r=m(O))?void 0:r.token)||""),1),m(O).amount&&m(i)(m(O).amount).gt(0)&&m(i)(m($)).minus(m(O).amount||0).gte(0)?(c(),s("span",mi," -> "+v(("formatNumber"in e?e.formatNumber:m(B))(m(i)(m($)).minus(m(O).amount||0).toFixed(),6))+" "+v((null==(n=m(O))?void 0:n.token)||""),1)):S("",!0)]),!m(H)&&m(re)?(c(),s("div",pi,[p("div",gi,v(e.$t("depositApproveTips1",{chain:m(ie),token:m(O).token})),1),p("div",hi,v(e.$t("depositApproveTips2",{chain:m(ie),token:m(O).token})),1),g(F,{type:"primary",class:"rd-8px mt-20px",loading:m(le),onClick:x(se,["stop"])},{default:f(()=>[w(v(e.$t("enableToken",{token:m(O).token})),1)]),_:1},8,["loading"])])):S("",!0),p("div",vi,[p("span",fi,v(e.$t("arrivalTime")),1),p("span",wi,"â‰ˆ 2"+v(e.$t("minutes")),1)]),p("div",xi,[p("span",Ii,v(e.$t("totalBalance1")),1),p("span",Ri,v(("formatNumber"in e?e.formatNumber:m(B))(m(Y),4)),1),m(O).amount&&m(i)(m(O).amount).gt(0)&&m(i)(m(Y)).plus(m(O).amount||0).gte(0)?(c(),s("span",Si," -> "+v(("formatNumber"in e?e.formatNumber:m(B))(m(i)(m(Y)).plus(m(O).amount||0).toFixed(),6)),1)):S("",!0),p("span",Pi,v((null==(a=m(O))?void 0:a.token)||""),1)]),m(H)&&m(re)?(c(),R(F,{key:1,type:"primary",size:"large",class:"w-full text-16px h-48px rd-8px mt-20px",loading:m(ce),onClick:x(ue,["stop"])},{default:f(()=>[w(v(e.$t("confirmDeposit")),1)]),_:1},8,["loading"])):(c(),s("button",Fi,v(e.$t("confirmDeposit")),1))])}}}),[["__scopeId","data-v-8df7d300"]]),yi={class:"perp-deposit"},bi={class:"color-[--third-text]"},Ti={class:"inline-flex items-center vertical-middle"},Li=["src"],Oi=["src"],Ei={class:"color-[--third-text]"},Ni={class:"inline-flex items-center vertical-middle"},zi=["src"],Mi=["src"],Ci={class:"flex items-center justify-between mb-16px text-14px bg-[--border] h-40px rd-6px px-12px"},Ai={class:"color-[--third-text]"},_i={class:"color-[--third-text]"},Bi={class:"text-12px color-[--third-text] mt-8px text-right"},Di={key:0},Ui={key:0,class:"text-14px flex items-center justify-between mt-16px rd-4px"},Vi={class:"color-[--secondary-text]"},qi={class:"color-[--main-text]"},Ki={class:"text-14px flex items-center justify-between mt-16px rd-4px"},Gi={class:"color-[--secondary-text]"},Wi={class:"color-[--main-text]"},$i={class:"text-14px flex items-center justify-between mt-16px rd-4px"},Yi={class:"color-[--secondary-text]"},ji={class:"color-[--main-text]"},Zi={key:3,disabled:"",class:"w-full text-16px h-48px bg-[--border] color-[--secondary-text] flex items-center justify-center border-none rd-8px mt-20px cursor-not-allowed"},Hi={key:4,class:"mt-16px font-400"},Xi={class:"flex items-center color-[--main-text] text-12px mb-8px"},Ji={class:"text-12px color-[--secondary-text] lh-16px"},Qi={key:5,class:"mt-16px font-400"},er={class:"flex items-center color-[--main-text] text-12px mb-8px"},tr={class:"text-12px color-[--secondary-text] lh-16px"},ir=$(n({__name:"withdraw",props:{getVisible:{type:Function,default:()=>o(!1)}},emits:["success"],setup(e,{emit:t}){const n=e,u=t,d=F(),{t:y}=N(),T=z({chain:"56",token:"USDT",amount:""}),L=M(()=>i(mt("","1000")||"0").dp(6,i.ROUND_FLOOR).toString()),O=M(()=>i(L.value).minus(T.amount||0));function E(){T.amount=new i(L.value).toFixed()}function C(){var e,t,i,r,n;return null==(n=null==(r=null==(i=null==(t=null==(e=$.metadata)?void 0:e.multiChain)?void 0:t.chainList)?void 0:i.find(e=>e.chainId===T.chain))?void 0:r.tokenList)?void 0:n.find(e=>e.token===T.token)}const D=o({}),q=M(()=>{var e;return"1"==T.chain?"âˆž":(null==(e=D.value)?void 0:e[T.token+"-"+T.chain])||0});async function W(){var e,t,r,n,a;if(!T.token||!T.chain)return;const o=null==(r=null==(t=null==(e=$.metadata)?void 0:e.multiChain)?void 0:t.chainList)?void 0:r.find(e=>e.chainId===T.chain),l=null==(n=null==o?void 0:o.tokenList)?void 0:n.find(e=>e.token===T.token),s=null==l?void 0:l.decimals,c=(null==o?void 0:o.appRpcUrl)||(null==(a=k(T.chain,!0))?void 0:a.rpc_url),u=new Y(c,Number(T.chain));let d=BigInt(0);const m=new b((null==l?void 0:l.tokenAddress)||"",j,u);d=await m.balanceOf(null==l?void 0:l.contractAddress),D.value[T.token+"-"+T.chain]=U(new i(d.toString()).toFixed(0),Number(s))}const $=r(),Z=[{token:"USDT",iconUrl:"https://static.edgex.exchange/icons/coin/USDT.svg"},{token:"USDC",iconUrl:"https://static.edgex.exchange/icons/coin/USDC.svg"}],H=M(()=>{var e,t;return null==(t=(null==(e=$.metadata)?void 0:e.multiChain.chainList)||[])?void 0:t.filter(e=>{var t;return null==(t=e.tokenList)?void 0:t.some(e=>e.token===T.token)})});a(H,e=>{if(e.length){if(null==e?void 0:e.some(e=>e.chainId===T.chain))return;T.chain=e[0].chainId}});const X=M(()=>{var e,t,r,n;const a=new i(T.amount||0);return T.chain&&T.token&&T.amount&&(null==(n=null==(r=(null==(t=null==(e=$.metadata)?void 0:e.multiChain)?void 0:t.chainList)||[])?void 0:r.some)?void 0:n.call(r,e=>e.chainId===T.chain))&&("âˆž"===q.value||a.lte(q.value))&&a.lte(L.value)});a(()=>T.token,()=>{W(),te()});const J=o("0"),Q=M(()=>{var e,t,r;const n=null==(r=null==(t=null==(e=$.metadata)?void 0:e.multiChain)?void 0:t.chainList)?void 0:r.find(e=>e.chainId===T.chain);return new i((null==n?void 0:n.feeRate)||5e-5).times(100).toFixed()}),ee=M(()=>i.max(i(T.amount||0).minus(J.value||0),0).toFixed());function te(){if(J.value="0",!T.token||!T.chain||!T.amount)return;const e=C();return e?Xt({tokenAddress:e.tokenAddress||"",chain:T.chain,amount:new i(T.amount).toFixed()}).then(e=>{J.value=e.fee}):void 0}function ie(){var e,t,i;const r=(null==(e=$.metadata)?void 0:e.multiChain.chainList)||[],n=(null==(t=k(d.chain))?void 0:t.chain_id)||(null==(i=null==r?void 0:r[0])?void 0:i.chainId);T.token="USDT",(null==r?void 0:r.some(e=>e.chainId===n))?(T.chain=n,W()):T.chain=void 0}a(()=>T.amount,()=>{te()}),a(()=>n.getVisible().value,e=>{e&&ie()}),a(()=>T.chain,e=>{e&&(W(),te())});const re=o(!1);async function ne(){var e,t;if(!X.value)return;const r=(null==(t=null==(e=$.metadata)?void 0:e.multiChain)?void 0:t.minWithdraw)||0;if(i(T.amount||0).lte(J.value||0))return void G.error(y("withdrawTooSmall"));if(new i(T.amount||0).lt(r))return void G.error(y("minWithdraw",{amount:r}));re.value=!0;const n=C(),a=T.amount||"0";Ht({tokenAddress:(null==n?void 0:n.tokenAddress)||"",amount:a,chain:T.chain||""}).then(e=>{V({type:"success",message:y("withdrawSubmitted")}),u("success",e),re.value=!1}).catch(e=>{re.value=!1,K(e)})}return l(()=>{ie()}),(e,t)=>{var r,n,a,o,l,u;const d=ae,F=oe,y=_,b=I,N=h;return c(),s("div",yi,[g(F,{modelValue:m(T).token,"onUpdate:modelValue":t[0]||(t[0]=e=>m(T).token=e),placeholder:"Select",class:"mb-16px",size:"large",persistent:!1},{prefix:f(()=>[p("div",bi,v(e.$t("token")),1)]),label:f(({value:e,label:t})=>{var i,r;return[p("div",Ti,[p("img",{src:null==(r=null==(i=null==Z?void 0:Z.find)?void 0:i.call(Z,t=>t.token===e))?void 0:r.iconUrl,class:"rd-50% mr-5px",width:"24",lazy:"",alt:""},null,8,Li),p("span",null,v(t||""),1)])]}),default:f(()=>[(c(),s(P,null,A(Z,e=>g(d,{key:e.token,label:e.token,value:e.token,class:"h-40px! flex items-center"},{default:f(()=>[p("img",{src:e.iconUrl,class:"rd-50% mr-5px",width:"24",lazy:"",alt:""},null,8,Oi),p("span",null,v(e.token||""),1)]),_:2},1032,["label","value"])),64))]),_:1},8,["modelValue"]),g(F,{modelValue:m(T).chain,"onUpdate:modelValue":t[1]||(t[1]=e=>m(T).chain=e),class:"mb-16px",placeholder:"Select",style:{width:"100%"},size:"large",persistent:!1},{prefix:f(()=>[p("div",Ei,v(e.$t("chain1")),1)]),label:f(({value:t,label:i})=>{var r,n,a;return[p("div",Ni,[p("img",{src:null==(r=m(H).find(e=>e.chainId===t))?void 0:r.chainIconUrl,class:"rd-50% mr-5px",width:"24",lazy:"",alt:""},null,8,zi),p("span",null,v((null==(n=m(H).find(e=>e.chainId===t))?void 0:n.chain)||(null==(a=("getChainInfo"in e?e.getChainInfo:m(k))(t,!0))?void 0:a.name)||i||""),1)])]}),default:f(()=>[(c(!0),s(P,null,A(m(H),e=>(c(),R(d,{key:e.chainId,label:e.chain,value:e.chainId,class:"h-40px! flex items-center"},{default:f(()=>[p("img",{src:e.chainIconUrl,class:"rd-50% mr-5px",width:"24",lazy:"",alt:""},null,8,Mi),p("span",null,v(e.chain||""),1)]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue"]),p("div",Ci,[p("span",Ai,v(e.$t("poolBalance")),1),p("span",null,v("âˆž"!==m(q)?("formatNumber"in e?e.formatNumber:m(B))(m(q),{limit:6,decimals:0}):"0")+" "+v((null==(r=m(T))?void 0:r.token)||""),1)]),g(y,{modelValue:m(T).amount,"onUpdate:modelValue":t[2]||(t[2]=e=>m(T).amount=e),class:"text-right",inputmode:"decimal",clearable:"",placeholder:"0.00",size:"large",onInput:t[3]||(t[3]=e=>m(T).amount=e.replace(/\-|[^\d.]/g,""))},{prefix:f(()=>[p("div",_i,v(e.$t("amount")),1)]),suffix:f(()=>[p("button",{class:"color-[--primary-color] border-none bg-transparent clickable text-14px",onClick:x(E,["stop"])},v(e.$t("max")),1)]),_:1},8,["modelValue"]),p("div",Bi,[p("span",null,v(e.$t("available"))+": ",1),p("span",null,v(m(L))+" "+v((null==(n=m(T))?void 0:n.token)||""),1),m(T).amount&&m(i)(m(T).amount).gt(0)&&m(O).gte(0)?(c(),s("span",Di," -> "+v(m(O))+" "+v((null==(a=m(T))?void 0:a.token)||""),1)):S("",!0)]),"1"===m(T).chain?(c(),s("div",Ui,[p("span",Vi,v(e.$t("withdrawAmount")),1),p("span",qi,v(("formatNumber"in e?e.formatNumber:m(B))(m(T).amount,3))+" "+v((null==(o=m(T))?void 0:o.token)||""),1)])):(c(),s(P,{key:1},[p("div",Ki,[p("span",Gi,v(e.$t("fee"))+"/"+v(e.$t("feeRate")),1),p("span",Wi,v(("formatNumber"in e?e.formatNumber:m(B))(m(J),3))+" "+v((null==(l=m(T))?void 0:l.token)||"")+" / "+v(("formatNumber"in e?e.formatNumber:m(B))(m(Q),3))+"%",1)]),p("div",$i,[p("span",Yi,v(e.$t("amountReceive")),1),p("span",ji,v(("formatNumber"in e?e.formatNumber:m(B))(m(ee),3))+" "+v((null==(u=m(T))?void 0:u.token)||""),1)])],64)),m(X)?(c(),R(b,{key:2,type:"primary",size:"large",class:"w-full text-16px h-48px rd-8px mt-20px",loading:m(re),onClick:x(ne,["stop"])},{default:f(()=>[w(v(e.$t("confirmWithdrawal")),1)]),_:1},8,["loading"])):(c(),s("button",Zi,v(e.$t("confirmWithdrawal")),1)),"1"===m(T).chain?(c(),s("div",Hi,[p("div",Xi,[g(N,{name:"carbon:warning-filled",class:"text-14px mr-3px mb--1px"}),p("span",null,v(e.$t("withdrawTipsTitle")),1)]),p("div",Ji,v(e.$t("withdrawTips")),1)])):(c(),s("div",Qi,[p("div",er,[g(N,{name:"carbon:warning-filled",class:"text-14px mr-3px mb--1px"}),p("span",null,v(e.$t("crossWithdrawIntro")),1)]),p("div",tr,v(e.$t("crossWithdrawDesc")),1)]))])}}}),[["__scopeId","data-v-ff46e1af"]]),rr={class:"absolute top-20px left-20px flex items-center text-20px font-700"},nr={class:"text-16px color-[--third-text] ml-2px"},ar={class:"mt-30px text-14px color-[--main-text]"},or={class:"flex items-center justify-between"},lr={class:"color-[--third-text]"},sr={class:"flex items-center justify-between mt-16px"},cr={class:"color-[--third-text]"},ur={class:"flex items-center justify-between mt-16px"},dr={class:"color-[--third-text]"},mr={class:"flex items-center justify-between mt-16px"},pr={class:"color-[--third-text]"},gr={key:0,class:"flex items-center justify-between mt-16px"},hr={class:"color-[--third-text]"},vr={class:"color-[--up-color]"},fr={key:1,class:"flex items-center justify-between mt-16px"},wr={class:"color-[--third-text]"},xr={class:"color-[--down-color]"},Ir={class:"flex items-center justify-between mt-16px"},Rr=n({__name:"createOrder",props:{getVisible:{type:Function,default:()=>o(!1)},orderParams:{type:Object,default:()=>({})}},emits:["success","cancel"],setup(e,{emit:t}){const{t:i}=N(),n=e,a=t,l=r(),u=M(()=>({MARKET:i("market"),LIMIT:i("limit"),STOP_MARKET:i("stop_market"),STOP_LIMIT:i("stop_limit"),TAKE_PROFIT_MARKET:i("takeProfitMarket"),TAKE_PROFIT_LIMIT:i("takeProfitLimit")})),d=M(()=>{const e=n.orderParams.contractId||"",t=(l.contractList||[]).find(t=>t.contractId===e);return null==t?void 0:t.contractName}),h=M(()=>{const e=n.orderParams.contractId||"";return at(e)}),R=M(()=>{var e;const t=n.orderParams.contractId||"",i=n.orderParams.price||"0",r=n.orderParams.size;return lt({contractId:t,side:n.orderParams.side,price:"LIMIT"===n.orderParams.type?Number(i):0,size:Number(r||0),oraclePrice:Number((null==(e=l.perp)?void 0:e.oraclePrice)||"0")}).toFixed()}),F=o(!1);function k(){F.value=!0,Jt(n.orderParams).then(e=>{a("success",e),V({type:"success",message:i("orderSubmitted")})}).catch(e=>{V({type:"error",message:null==e?void 0:e.message})}).finally(()=>{F.value=!1})}return(t,r)=>{var n,a,o,l,y,b,T,L,O,E,N;const z=I;return c(),s(P,null,[p("div",rr,[p("div",{class:Z(["BUY"===e.orderParams.side?"bg-[--up-color]":"bg-[--down-color]","text-12px p-2px rd-2px font-400 mr-5px color-[--white]"])},v("BUY"===e.orderParams.side?m(i)("buy1"):m(i)("sell1")),3),p("div",null,v(m(d)||""),1),p("div",nr,v(m(h))+"X",1)]),p("ul",ar,[p("li",or,[p("span",lr,v(t.$t("price")),1),p("span",null,v((null==(n=e.orderParams.type)?void 0:n.includes("LIMIT"))?("formatNumber"in t?t.formatNumber:m(B))(e.orderParams.price,10):m(u)[e.orderParams.type]),1)]),p("li",sr,[p("span",cr,v(t.$t("amount")),1),p("span",null,v(e.orderParams.size),1)]),p("li",ur,[p("span",dr,v(t.$t("margin")),1),p("span",null,v(("formatNumber"in t?t.formatNumber:m(B))(m(R),4))+" USD",1)]),p("li",mr,[p("span",pr,v(t.$t("onlyReduce")),1),p("span",null,v(e.orderParams.reduceOnly?m(i)("yes"):m(i)("no")),1)]),(null==(a=e.orderParams)?void 0:a.isSetOpenTp)&&(null==(l=null==(o=e.orderParams)?void 0:o.openTp)?void 0:l.triggerPrice)?(c(),s("li",gr,[p("span",hr,v(t.$t("TPPrice")),1),p("span",vr," >= "+v(("formatNumber"in t?t.formatNumber:m(B))((null==(b=null==(y=e.orderParams)?void 0:y.openTp)?void 0:b.triggerPrice)||0,10))+" USD",1)])):S("",!0),(null==(T=e.orderParams)?void 0:T.isSetOpenSl)&&(null==(O=null==(L=e.orderParams)?void 0:L.openSl)?void 0:O.triggerPrice)?(c(),s("li",fr,[p("span",wr,v(t.$t("SLPrice")),1),p("span",xr," <= "+v(("formatNumber"in t?t.formatNumber:m(B))((null==(N=null==(E=e.orderParams)?void 0:E.openSl)?void 0:N.triggerPrice)||0,10))+" USD",1)])):S("",!0),p("li",Ir,[g(z,{size:"large",class:"flex-1 min-h-48px rd-8px!",onClick:r[0]||(r[0]=x(e=>t.$emit("cancel"),["stop","prevent"]))},{default:f(()=>[w(v(t.$t("cancel")),1)]),_:1}),g(z,{size:"large",type:"primary",class:"flex-1 min-h-48px rd-8px!",loading:m(F),onClick:x(k,["stop","prevent"])},{default:f(()=>[w(v(t.$t("confirm")),1)]),_:1},8,["loading"])])])],64)}}});function Sr(){const e=o(!1),t=r(),n=F(),l=H(),{mode:s}=X(J()),{t:c}=N(),u=M(()=>{var e;const r=t.position||[],n=t.contractList;return null==(e=null==r?void 0:r.map)?void 0:e.call(r,e=>{var t,r;const a=n.find(t=>t.contractId===e.contractId),o=(null==a?void 0:a.oraclePrice)||0,l=new i(o||0).times(new i((null==e?void 0:e.openSize)||0)),s=(null==a?void 0:a.riskTierList)||[],c=null==(t=null==s?void 0:s.find)?void 0:t.call(s,e=>new i(l).lte((null==e?void 0:e.positionValueUpperBound)||0)),u=null==(r=null==s?void 0:s.find)?void 0:r.call(s,t=>new i(e.openValue||0).lte((null==t?void 0:t.positionValueUpperBound)||0));return{...e,...a,maintenanceMarginRequirementObj:c,initialMarginRequirementObj:u}})}),d=M(()=>{var e,r;const n=(null==(r=null==(e=t.collateral)?void 0:e[0])?void 0:r.amount)||0,a=u.value.reduce((e,t)=>{const r=(null==t?void 0:t.oraclePrice)||0;let n=new i(r||0).times(new i((null==t?void 0:t.openSize)||0));return new i(r).isZero()&&(n=new i((null==t?void 0:t.openValue)||0)),e.plus(n)},new i(0));return new i(n).plus(a).toFixed()}),m=M(()=>u.value.reduce((e,t)=>{const r=(null==t?void 0:t.oraclePrice)||0,n=Number(null==t?void 0:t.openValue)>=0?new i(r).times(new i((null==t?void 0:t.openSize)||0).abs()).minus(new i(t.openValue).abs()):new i(t.openValue||0).abs().minus(new i(r).times(new i(t.openSize).abs()));return e.plus(n)},new i(0)).toFixed()),p=M(()=>u.value.reduce((e,t)=>{var r;const n=(null==t?void 0:t.oraclePrice)||0,a=(null==t?void 0:t.openSize)||0,o=(null==(r=t.initialMarginRequirementObj)?void 0:r.maxLeverage)||1,l=new i(1).div(o),s=new i(n||0).times(new i(a)),c=l.times(s.abs());return e.plus(c)},new i(0)).toFixed()),g=M(()=>u.value.reduce((e,t)=>{var r;const n=(null==t?void 0:t.oraclePrice)||0,a=(null==t?void 0:t.openSize)||0,o=(null==(r=t.maintenanceMarginRequirementObj)?void 0:r.maintenanceMarginRate)||1,l=new i(o).times(a).times(n);return e.plus(l)},new i(0)).abs().toFixed());function h(){const t=ee();if(!n.address)return void G.error(t("connectWalletFirst"));if(!n.provider&&n.address)return void te.confirm(c("watchWalletUnSupportPerp"),c("tips"),{type:"warning",icon:ie(re),confirmButtonText:c("iKnown"),showCancelButton:!1,customClass:`${s.value} delete_confirm`});if(n.address&&!ne(n.chain))return void G.error(t("noevmWalletNotSupportedPerp"));const{$dialog:i}=Q();e.value=!0,i.show({content:{is:$t,props:{onSuccess:()=>{i.hide()},getVisible:()=>e}},props:{width:"450px",class:"perp-dialog",title:t("loginPerpAccount"),onOpened:()=>{e.value=!0},onClosed:()=>{e.value=!1}}})}const v=M(()=>n.address&&n.provider&&t.isLogin&&new i(t.normalWithdrawableAmount||"0").gt(0));return{dialogVisible:e,prepBalance:d,unrealizedPnl:m,initMarginRequirement:p,maintenanceMarginRequirement:g,isCanNormalWithdrawableAmount:v,login:h,connectAndLogin:function(){if(n.address)return void(t.isLogin||h());if(l.evmAddress)return void te.confirm(c("botUnSupportPerp"),c("tips"),{type:"warning",icon:ie(re),confirmButtonText:c("iKnown"),showCancelButton:!1,customClass:`${s.value} delete_confirm`});l.changeConnectVisible(!0,1);const e=a(()=>n.address,i=>{var r;i&&(null==(r=n.walletSignature)?void 0:r[(null==n?void 0:n.address)||""])&&(e(),t.isLogin||h())}),i=a(()=>l.connectVisible,t=>{t||(e(),i())})},deposit:function(){const{$dialog:t}=Q(),i=ee();e.value=!0,t.show({content:{is:ki,props:{onSuccess:()=>{t.hide()},getVisible:()=>e}},props:{width:"450px",class:"perp-dialog",title:i("deposit2"),onOpened:()=>{e.value=!0},onClosed:()=>{e.value=!1}}})},withdraw:function(){const{$dialog:t}=Q(),i=ee();e.value=!0,t.show({content:{is:ir,props:{onSuccess:()=>{t.hide()},getVisible:()=>e}},props:{width:"450px",class:"perp-dialog",title:i("withdraw"),onOpened:()=>{e.value=!0},onClosed:()=>{e.value=!1}}})},createPerpOrder:function(t){return new Promise((i,r)=>{const{$dialog:n}=Q();e.value=!0,n.show({content:{is:Rr,props:{onSuccess:()=>{n.hide(),i(!0)},onCancel:()=>{n.hide(),i(!1)},getVisible:()=>e,orderParams:t}},props:{width:"450px",class:"perp-dialog",title:"",onOpened:()=>{e.value=!0},onClosed:()=>{e.value=!1}}})})}}}export{St as C,le as D,Zt as E,at as a,gt as b,mt as c,ft as d,lt as e,nt as f,vt as g,st as h,ut as i,ct as j,ht as k,Jt as l,pt as m,dt as n,ot as t,Sr as u};
